<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="LLM으로 생각보다 은근히 편리한 가톨릭 한국어 미사 슬라이드덱 편집기">
    <!--<meta name="author" content="">-->
    <title>LLM으로 생각보다 은근히 편리한 가톨릭 한국어 미사 슬라이드덱 편집기</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.40.0/ace.js" integrity="sha512-fIGectJ0WRU6B2gx99VwpUsCu5T3pqAkPOLE2BJD5wowKmpejvdYg62WvsQ6f3jfOC5EGL0y0ZLcXnnc+oWG9g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago@1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard-js@0.3.6/clipboard.min.js"></script>


    <link rel="icon" href="favicon.ico">

  </head>
  <body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="" id="menu_title">미사 슬라이드덱 편집기</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#today" id="load_today">오늘</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#tomorrow" id="load_tomorrow">내일</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#saturday" id="load_saturday">토요일</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#sunday" id="load_sunday">일요일</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">2025년</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="load_1">1월</a></li>
            <li><a class="dropdown-item" href="#" id="load_2">2월</a></li>
            <li><a class="dropdown-item" href="#" id="load_3">3월</a></li>
            <li><a class="dropdown-item" href="#" id="load_4">4월</a></li>
            <li><a class="dropdown-item" href="#" id="load_5">5월</a></li>
            <li><a class="dropdown-item" href="#" id="load_6">6월</a></li>
            <li><a class="dropdown-item" href="#" id="load_7">7월</a></li>
            <li><a class="dropdown-item" href="#" id="load_8">8월</a></li>
            <li><a class="dropdown-item" href="#" id="load_9">9월</a></li>
            <li><a class="dropdown-item" href="#" id="load_10">10월</a></li>
            <li><a class="dropdown-item" href="#" id="load_11">11월</a></li>
            <li><a class="dropdown-item" href="#" id="load_12">12월</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">성가 추가</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="hymn_0">1번 ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_1">100번 ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_2">200번 ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_3">300번 ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_4">400번 ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_5">500번 ~</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item hymn_menu" href="#">대림(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">성탄(23)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">사순(16)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">부활(15)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">성령(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">성체(61)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">성심(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">봉헌(17)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">참회(9) </a></li>
            <li><a class="dropdown-item hymn_menu" href="#">위령(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">성모(52)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">성인(16)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">축가(11)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">미사곡(93)</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" onclick="load_prayers()">기도문 추가</a>
        </li>
      </ul>
      <form class="form-inline my-2 my-lg-0">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="" target="_blank">자습서</a>
          </li>
        </ul>
      </form>
    </div>
  </div>
</nav>

<!-- First Modal -->
<div class="modal fade" id="startupModal" tabindex="-1" aria-labelledby="startupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="startupModalLabel"><small><i>LLM으로 생각보다 은근히 편한</i></small><br/>가톨릭 한국어 미사 슬라이드덱 편집기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
        평화를 빕니다!
        </p>
        <p>
        이 웹사이트는 전 세계 곳곳에서 미사 슬라이드덱 봉사를 하고 계신 한인 가톨릭 공동체의 형제자매님들께 도움이 되고자 만들어졌습니다.
        </p>
        <p>
        5분 정도 자습서를 따라 해 보시면, 이 LLM을 이용한 대화형 편집기로 <i>생각보다 은근히</i> 쉽게 슬라이드덱을 만들 수 있다는 감이 오실 거예요.
        </p>
        <small>
        이 웹사이트는 <b>데스크톱</b> 브라우저 환경에 최적화되어 있습니다. 혹시! 모바일에서 열어보셨다면 <i>생각보다 은근히</i> 불편하실 수 있으니, 집에 돌아가신 후 컴퓨터로 다시 방문하시길 권해드립니다.
        <b>PDF 인쇄 기능은 Chrome 브라우저</b>를 사용하시는 것을 추천드립니다.
        </small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="never_see_startup()">다시 보지 않기</button>
      </div>
    </div>
  </div>
</div>

<!-- Load Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="loadModalLabel">로컬 브라우저 저장소 불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>어떻게 작동 하나요?</small> <a id="readMore3" data-bs-toggle="collapse" href="#moreText3" aria-expanded="false" aria-controls="moreText3"><small>자세히</small></a></small>
          <span id="moreText3" class="collapse"><br/><small>편집기로 작성 중인 Markdown 문서에서 Heading 1 (#) 또는 Heading 2 (##) 가 적용된 문자열을 추출해서 문서 제목으로 간주 합니다. 이 제목을 Key로 정하고 웹 표준 기술인 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API" target="_blank">Web Storage API</a>을 이용하여 전체 Markdown 데이타를 사용중인 디바이스의 웹브라우저에 저장하고 불러 옵니다. 따라서 서버에는 그 어떤 정보도 저장되지 않습니다.</small><br/>
          <small>로컬 브라우저 저장소는 어떤 이유에서건 사라질 수 있습니다. 작성하신 문서는 다운로드 기능을 사용하여 Markdown (확장자.md) 파일로 직접 안전하게 저장해 두시는 것을 권장합니다.</small></span>
        </p>
        <div class="list-group" id="saved">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="shareModalLabel">다른 슬라이드덱 봉사자와 편집 내용 공유하기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>편집 중인 마크다운 소스를 직접 파일에 저장 또는 Email로 공유 하거나 다음의 주소를 보내어 다른 사람과 편집 내용을 쉽게 공유할 수 있습니다.</small>
        </p>
        <p>
          <small>어떻게 작동 하나요?</small> <a id="readMore2" data-bs-toggle="collapse" href="#moreText2" aria-expanded="false" aria-controls="moreText2"><small>자세히</small></a></small>
          <span id="moreText2" class="collapse"><br/><small>편집기에 입력된 Markdown 텍스트는 gzip 으로 압축 된 뒤 Base64로 인코딩 되어 현재 웹페이지의 URL에 해시(#) 식별자 형식으로 연결됩니다. 이 긴 URL은 E-mail이나 메신저 등을 통해 공유되며, 전달 받는 측에서 역순으로 해시(#) 식별자 정보를 디코딩 및 압축 해제되어 편집기에 입력되어 작업을 이어갈 수 있습니다.</small><br/>
          <small>URL이 다소 길순 있지만 뭐 괜찮습니다.</small></span>
        </p>
        <div class="card">
          <h5 class="card-header">URL</h5>
          <div class="card-body" id="shareURL">
          </div>
        </div>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="clipboard.copy($('#shareURL').text().trim());">복사</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="settingsModalLabel">Markdown 에디터 설정</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <input class="form-check-input" type="checkbox" value="" id="vim_mode" onclick="set_keybinding(this.checked)">
        <label class="form-check-label" for="vim_mode" data-bs-toggle="tooltip" data-bs-placement="top" title="Vim 키 바인딩으로 편집합니다">
          Vim 키바인딩&nbsp;&nbsp;
        </label>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Month Modal -->
<div class="modal fade" id="monthModal" tabindex="-1" aria-labelledby="monthModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="monthModalLabel">불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="month_list">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Hymn Modal -->
<div class="modal fade" id="hymnModal" tabindex="-1" aria-labelledby="hymnModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="hymnModalLabel">불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="hymn_list">
        </div>
      </div>
      <div class="modal-footer">
        <div id="hymn_preview" class="alert alert-secondary" style="width: 100%" role="alert"></div>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="hymn_add_button" style="display: none" onclick="add_hymn()">추가</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Prayer Modal -->
<div class="modal fade" id="prayerModal" tabindex="-1" aria-labelledby="prayerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="prayerModalLabel">기도문 목록</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="prayer_list">
        </div>
      </div>
      <div class="modal-footer">
        <div id="prayer_preview" class="alert alert-secondary" style="width: 100%" role="alert"></div>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="prayer_add_button" style="display: none" onclick="add_prayer()">추가</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- ollama error modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">로컬 Ollama 서버에 접속 불가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="errorText"></p>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid">
  <div class="row ms-1 me-1">
    <div id="notice_div" class="alert alert-primary" role="alert" style="display: none"></div>
    <div id="error_div" class="alert alert-danger" role="alert" style="display: none"></div>
  </div>
  <div id="mdrow" class="row">
    <div class="col-md-4" id="left-pane">
      <ul class="nav nav-tabs" id="leftTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="ollama-tab" data-bs-toggle="tab" data-bs-target="#ollama" type="button" role="tab" aria-controls="ollama" aria-selected="false"><img src="https://ollama.com/public/ollama.png" style="height: 30px; margin-top: -8px"> 로컬 Ollama와 대화 하기</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="mdeditor-tab" data-bs-toggle="tab" data-bs-target="#mdeditor" type="button" role="tab" aria-controls="mdeditor" aria-selected="true">편집기</button>
        </li>
      </ul>
      <div class="tab-content" id="tabContent">
        <div class="tab-pane fade" id="mdeditor" role="tabpanel" aria-labelledby="mdeditor-tab" style="height: 100%">
          <table class="editor-toolbar" style="width: 100%">
            <tr>
              <td>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우저 데이타베이스에서 불러오기" onclick="$('#loadModal').modal('show');update_saved_docs();"><i class="bi bi-folder2-open"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우저에 데이타베이스에 저장" onclick="save_edit()"><i class="bi bi-floppy2"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Markdown 파일로 다운로드 하기" id="mdDownloadButton"><i class="bi bi-download"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="공유 하기" id="shareButton"><i class="bi bi-box-arrow-up"></i></button>
              </td>
              <td style="text-align: right;">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="다크/라이트 모드로 토글" onclick="toggle_dark_mode()"><i class="bi bi-circle-half"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="편집기 설정" onclick="$('#settingsModal').modal('show')"><i class="bi bi-gear-wide-connected"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="클립보드에 복사" onclick="clipboard_copy()"><i class="bi bi-copy"></i></button>
              </td>
            </tr>
          </table>
          <div id="editor" style="height: 100%; width: 100%; border-style: solid; border-color: #eeeeee"></div>
        </div>





      <script src="https://cdn.jsdelivr.net/npm/marked@15.0.12/lib/marked.umd.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
      <style>
  .user-message {
    background-color: rgb(86, 144, 163);
    color: white;
    padding: 10px;
    border-radius: 10px;
    white-space: pre-wrap;
    margin-left: auto;
    max-width: 90%;
  }

  .response-message {
    background-color: rgb(62, 62, 62);
    color: white;
    padding: 10px;
    border-radius: 10px;
    padding-right: 20px;
    position: relative;
    margin-right: auto;
    max-width: 90%;
  }

  .response-message p {
    margin-right: 40px;
    /* Add more styles here */
  }

  #chat-history {
    display: flex;
    flex-direction: column;
  }

  #scroll-wrapper {
    padding-top: 20px;
    padding-right: 10px;
  }

  #user-input {
    overflow-y: auto;
    resize: none;         /* Prevent user from manually resizing */
    height: 40px;
    max-height: 200px;    /* Set your desired max height here */
  }
      </style>
        <div class="tab-pane fade show active" role="tabpanel" id="ollama" aria-labelledby="ollama-tab" style="overflow-y: scroll; height: 100%">
          <table style="width: 100%" class="mt-2">
            <tr>
              <td style="width: 25%">
                LLM 모델:
              </td>
              <td style="width: 75%">
                <select id="model-select" class="form-select" aria-label="모델 선택"></select>
              </td>
            </tr>
          </table>
          <div id="scroll-wrapper" style="height: 240px; overflow-y: scroll">
            <div id="chat-history"></div>
          </div>
          <div class="input-group" id="input-area">
            <textarea class="form-control" id="user-input" placeholder="여기에 질문 작성 후 Ctrl/Cmd+Enter" oninput="autoGrow(this)"></textarea>
            <button id="send-button" class="btn btn-primary">보내기</button>
          </div>
        </div>
      </div>
      <script>
var rebuildRules = undefined;
if (typeof chrome !== "undefined" && chrome.runtime && chrome.runtime.id) {
    rebuildRules = async function (domain) {
    const domains = [domain];
    /** @type {chrome.declarativeNetRequest.Rule[]} */
    const rules = [{
      id: 1,
      condition: {
        requestDomains: domains
      },
      action: {
        type: 'modifyHeaders',
        requestHeaders: [{
          header: 'origin',
          operation: 'set',
          value: `http://${domain}`,
        }],
      },
    }];
    await chrome.declarativeNetRequest.updateDynamicRules({
      removeRuleIds: rules.map(r => r.id),
      addRules: rules,
    });
  }
}


var ollama_host = 'http://localhost:11434';

if (rebuildRules){
  rebuildRules(ollama_host);
}

async function getModels(){
  const response = await fetch(`${ollama_host}/api/tags`);
  const data = await response.json();
  return data;
}


// Function to send a POST request to the API
function postRequest(data, signal) {
  const URL = `${ollama_host}/api/generate`;
  return fetch(URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data),
    signal: signal
  });
}

// Function to stream the response from the server
async function getResponse(response, callback) {
  const reader = response.body.getReader();
  let partialLine = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) {
      break;
    }
    // Decode the received value and split by lines
    const textChunk = new TextDecoder().decode(value);
    const lines = (partialLine + textChunk).split('\n');
    partialLine = lines.pop(); // The last line might be incomplete

    for (const line of lines) {
      if (line.trim() === '') continue;
      const parsedResponse = JSON.parse(line);
      callback(parsedResponse); // Process each response word
    }
  }

  // Handle any remaining line
  if (partialLine.trim() !== '') {
    const parsedResponse = JSON.parse(partialLine);
    callback(parsedResponse);
  }
}

const faqString = `
**로컬 Ollama 서버에 어떻게 연결해야 할까요?**

기본적으로, Ollama는 cross origin 연결을 127.0.0.1과 0.0.0.0으로 부터 허용합니다.

더 많은 origin을 지원하려면, OLLAMA_ORIGINS 환경 변수를 사용하세요:

\`\`\`
OLLAMA_ORIGINS=${window.location.origin} ollama serve
\`\`\`

더 읽어 볼 것: https://github.com/jmorganca/ollama/blob/main/docs/faq.md
`;



const clipboardIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
</svg>`
const textBoxBaseHeight = 40;  // This should match the default height set in CSS

// change settings of marked from default to remove deprecation warnings
// see conversation here: https://github.com/markedjs/marked/issues/2793
marked.use({
  mangle: false,
  headerIds: false
});

function autoFocusInput() {
  const userInput = document.getElementById('user-input');
  userInput.focus();
}

/*
takes in model as a string
updates the query parameters of page url to include model name
*/
// Fetch available models and populate the dropdown
async function populateModels() {
  document.getElementById('send-button').addEventListener('click', () => { submitRequest() });

  try {
    const data = await getModels();

    const selectElement = document.getElementById('model-select');
    selectElement.options.length = 0;
    selectElement.onchange = (() => {
      document.getElementById('chat-history').context = null;
      localStorage.setItem("kcatolic-api-ollama.model", selectElement.value);
      if(very_first_time_prompt != "") {
        submitRequest(very_first_time_prompt);
      }
    });
    const lastChosenModel = localStorage.getItem("kcatolic-api-ollama.model");

    data.models.forEach((model) => {
      const option = document.createElement('option');
      option.value = model.name;
      option.innerText = model.name;
      if(model.name == lastChosenModel) {
        option.selected = true;
      }
      selectElement.appendChild(option);
    });

  }
  catch (error) {
    document.getElementById('errorText').innerHTML =
    DOMPurify.sanitize(marked.parse(
    `다음과 같은 이유로 Ollama와 통신에 실패했습니다.:\n\n`
    + `\`\`\`${error.message}\`\`\`\n\n---------------------\n`
    + faqString));
    let modal = new bootstrap.Modal(document.getElementById('errorModal'));
    modal.show();
  }

  if(very_first_time_prompt != "") {
    submitRequest(very_first_time_prompt);
  }
}

// adjusts the padding at the bottom of scrollWrapper to be the height of the input box
function adjustPadding() {
  const inputBoxHeight = document.getElementById('input-area').offsetHeight;
  const scrollWrapper = document.getElementById('scroll-wrapper');
  scrollWrapper.style.paddingBottom = `${inputBoxHeight + 15}px`;
}

// sets up padding resize whenever input box has its height changed
const autoResizePadding = new ResizeObserver(() => {
  adjustPadding();
});
autoResizePadding.observe(document.getElementById('input-area'));



// Function to get the selected model
function getSelectedModel() {
  return document.getElementById('model-select').value;
}

// variables to handle auto-scroll
// we only need one ResizeObserver and isAutoScrollOn variable globally
// no need to make a new one for every time submitRequest is called
const scrollWrapper = document.getElementById('scroll-wrapper');
let isAutoScrollOn = true;
// autoscroll when new line is added
const autoScroller = new ResizeObserver(() => {
  if (isAutoScrollOn) {
    scrollWrapper.scrollIntoView({behavior: "smooth", block: "end"});
  }
});

// event listener for scrolling
let lastKnownScrollPosition = 0;
let ticking = false;
document.addEventListener("scroll", (event) => {
  // if user has scrolled up and autoScroll is on we turn it off
  if (!ticking && isAutoScrollOn && window.scrollY < lastKnownScrollPosition) {
    window.requestAnimationFrame(() => {
      isAutoScrollOn = false;
      ticking = false;
    });
    ticking = true;
  }
  // if user has scrolled nearly all the way down and autoScroll is disabled, re-enable
  else if (!ticking && !isAutoScrollOn &&
    window.scrollY > lastKnownScrollPosition && // make sure scroll direction is down
    window.scrollY >= document.documentElement.scrollHeight - window.innerHeight - 30 // add 30px of space--no need to scroll all the way down, just most of the way
  ) {
    window.requestAnimationFrame(() => {
      isAutoScrollOn = true;
      ticking = false;
    });
    ticking = true;
  }
  lastKnownScrollPosition = window.scrollY;
});

function removeBetween(arr, startVal, endVal) {
  if (typeof arr === "undefined" || !Array.isArray(arr)) {
    return arr;
  }
  const startIndex = arr.indexOf(startVal);
  const endIndex = arr.indexOf(endVal);

  if (startIndex === -1 || endIndex === -1 || startIndex >= endIndex) {
    return arr;
  }

  arr.splice(startIndex, endIndex - startIndex + 1);
  return arr;
}

var very_first_time_prompt = "";
// Function to handle the user input and call the API functions
async function submitRequest(promptString) {
  var input = document.getElementById('user-input').value.trim();
  var display_input = document.getElementById('user-input').value.trim();
  const selectedModel = getSelectedModel();
  const context = document.getElementById('chat-history').context;
  const systemPrompt = "";

  if(promptString && promptString.trim() != "") {
    input = promptString.trim();
    display_input = "평화를 빕니다~!";
  }

  if(input == "")
    return;

  const data = { model: selectedModel, prompt: input, context: removeBetween(context, 151648, 151649), system: systemPrompt, think: false};
  $("#send-button").prop("disabled", true);

  // Create user message element and append to chat history
  let chatHistory = document.getElementById('chat-history');
  let userMessageDiv = document.createElement('div');
  userMessageDiv.className = 'mb-2 user-message';
  userMessageDiv.innerText = display_input;
  chatHistory.appendChild(userMessageDiv);
  $("#scroll-wrapper").scrollTop($("#scroll-wrapper").prop("scrollHeight"));

  // Create response container
  let responseDiv = document.createElement('div');
  responseDiv.className = 'response-message mb-2 text-start';
  responseDiv.style.minHeight = '3em'; // make sure div does not shrink if we cancel the request when no text has been generated yet
  spinner = document.createElement('div');
  spinner.className = 'spinner-border text-light';
  spinner.setAttribute('role', 'status');
  responseDiv.appendChild(spinner);
  chatHistory.appendChild(responseDiv);
  $("#scroll-wrapper").scrollTop($("#scroll-wrapper").prop("scrollHeight"));

  // create button to stop text generation
  let interrupt = new AbortController();
  let stopButton = document.createElement('button');
  stopButton.className = 'btn btn-danger';
  stopButton.innerHTML = '중단';
  stopButton.onclick = (e) => {
    e.preventDefault();
    interrupt.abort('Stop button pressed');
  }
  // add button after sendButton
  const sendButton = document.getElementById('send-button');
  sendButton.insertAdjacentElement('beforebegin', stopButton);

  // change autoScroller to keep track of our new responseDiv
  autoScroller.observe(responseDiv);

  postRequest(data, interrupt.signal)
    .then(async response => {
      await getResponse(response, parsedResponse => {
        let word = parsedResponse.response;
        if (parsedResponse.done) {
          chatHistory.context = parsedResponse.context;
          /*
          // Copy button
          let copyButton = document.createElement('button');
          copyButton.className = 'btn btn-secondary copy-button';
          copyButton.innerHTML = clipboardIcon;
          copyButton.onclick = () => {
            navigator.clipboard.writeText(responseDiv.hidden_text).then(() => {
              console.log('Text copied to clipboard');
            }).catch(err => {
              console.error('Failed to copy text:', err);
            });
          };
          responseDiv.appendChild(copyButton);
          */

          // action handler
          const regex = /<!--\s*ACTION:([a-zA-Z0-9]+)\(([\s\S]*?)\)\s*-->/gs;

          let match;
          var action = "";
          var param = "";

          while ((match = regex.exec(responseDiv.hidden_text)) !== null) {
            action = match[1];
            param = match[2];
            break;
          }

          console.log(action, '(', param, ')');

          if(action != "" && param != "") {
            let actionButton = null;
            if (action == "addHymn") {
              var num = parseInt(param);
              if(num >= 1 && num <= 528) {
                actionButton = document.createElement('button');
                actionButton.innerHTML = num+"번 성가 추가";
                actionButton.onclick = () => {
                  add_hymn_by_number(param.trim());
                  actionButton.disabled = true;
                };
              }
            } else if (action == "addPrayer") {
              var supported = false;
              for(var i=0; i<prayers.length; i++) {
                if(prayers[i] == param.trim()) {
                  supported = true;
                  break;
                }
              }
              if(supported) {
                actionButton = document.createElement('button');
                actionButton.innerHTML = param.trim()+" 추가";
                actionButton.onclick = () => {
                  add_prayer_by_name(param.trim());
                  actionButton.disabled = true;
                };
              }
            } else if (action == "useTemplate") {
              function isValidDateFormat(str) {
                const regex = /^\d{4}\d{2}\d{2}$/;
                return regex.test(str);
              }
              if(isValidDateFormat(param.trim())) {
                actionButton = document.createElement('button');
                actionButton.innerHTML = param+" 템플릿 사용 (페이지 다시 로드 됨)";
                actionButton.onclick = () => {
                  window.location = window.location.origin + window.location.pathname + '#'+param.trim();
                  actionButton.disabled = true;
                };
              }
            } else if (action == "addPage") {
              actionButton = document.createElement('button');
              actionButton.innerHTML = "페이지 추가";
              actionButton.onclick = () => {
                var md = param.trim();
                if(md.startsWith('"'))
                  md = md.slice(1);
                if(md.startsWith("'"))
                  md = md.slice(1);
                if(md.startsWith("```"))
                  md = md.slice(3);
                if(md.startsWith("markdown"))
                  md = md.slice(8);
                if(md.endsWith('"'))
                  md = md.slice(0, md.length-1);
                if(md.endsWith("'"))
                  md = md.slice(0, md.length-1);
                if(md.endsWith("```"))
                  md = md.slice(0, md.length-3);
                if(md.startsWith("---"))
                  md = md.slice(3);
                if(md.endsWith("---"))
                  md = md.slice(0, md.length-3);
                add_markdown(md.replaceAll("\\n", "\n"));
                actionButton.disabled = true;
              };
            }
            if(actionButton) {
              actionButton.className = 'btn btn-secondary';
              responseDiv.appendChild(actionButton);
            }
          }

        }
        // add word to response
        if (word != undefined && word != "") {
          if (responseDiv.hidden_text == undefined){
            responseDiv.hidden_text = "";
          }
          word = word.replace(/<think>/g, '<details open><summary>think content</summary><br><span style="color:gray;">').replace(/<\/think>/g, '</span><hr></details>');
          responseDiv.hidden_text += word;
          var hidden_text = responseDiv.hidden_text;
          var comment_start = hidden_text.search("<!--");
          var comment_end = hidden_text.search("-->");
          if(comment_start >= 0 && comment_end < 0) {
            hidden_text = responseDiv.hidden_text.slice(0, comment_start);
            var nextLines = responseDiv.hidden_text.slice(comment_start).split("\n");
            for(var i=0; i<nextLines.length; i++) {
              if(i==0)
                hidden_text += nextLines[i]+" -->\n";
              else
                hidden_text += "<!-- "+nextLines[i]+" -->\n";
            }
          }
          //console.log("=======");
          //console.log(responseDiv.hidden_text);
          //console.log("-------");
          //console.log(hidden_text);
          //console.log("=======");
          responseDiv.innerHTML = DOMPurify.sanitize(marked.parse(hidden_text)); // Append word to response container
          $("#scroll-wrapper").scrollTop($("#scroll-wrapper").prop("scrollHeight"));
        }
      });
    })
    .then(() => {
      stopButton.remove(); // Remove stop button from DOM now that all text has been generated
      spinner.remove();
      $(sendButton).prop("disabled", false);
    })
    .catch(error => {
      if (error !== 'Stop button pressed') {
        console.error(error);
      }
      stopButton.remove();
      spinner.remove();
      $(sendButton).prop("disabled", false);
    });

  // Clear user input
  const element = document.getElementById('user-input');
  element.value = '';
  $(element).css("height", textBoxBaseHeight + "px");
}

// Event listener for Ctrl + Enter or CMD + Enter
document.getElementById('user-input').addEventListener('keydown', function (e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    if(!document.getElementById('send-button').disabled)
      submitRequest();
  }
});


function autoGrow(element) {
    const maxHeight = 200;  // This should match the max-height set in CSS

    // Count the number of lines in the textarea based on newline characters
    const numberOfLines = $(element).val().split('\n').length;

    // Temporarily reset the height to auto to get the actual scrollHeight
    $(element).css("height", "auto");
    let newHeight = element.scrollHeight;

    // If content is one line, set the height to baseHeight
    if (numberOfLines === 1) {
        newHeight = textBoxBaseHeight;
    } else if (newHeight > maxHeight) {
        newHeight = maxHeight;
    }

    $(element).css("height", newHeight + "px");
}

const prayers = ["감사기도", "강복", "거룩하시도다", "니케아콘스탄티노플리스신경", "대영광송", "부속가", "부활삼종기도", "사도신경", "삼종기도-성모송포함", "삼종기도", "성모송", "신앙의신비", "영성체전기도", "예물준비기도", "자비송", "주님의기도", "참회예절", "파견", "평화예식", "하느님의어린양"];
var prayer_list = "";
for(var i=0; i<prayers.length; i++) {
  prayer_list += "- "+prayers[i]+"\n";
}

const common_prompt = `You are an assistant named "은근한 도우미" who helps users create Catholic Mass slides using Marp in Korean. You are part of a website titled "LLM으로 은근히 편리한 미사 슬라이드덱 편집기".

## Language and Persona
- **Always answer in Korean only.**
- Do not include English translations.
- Greet with **"평화를 빕니다~!"**
- Your speaking tone must reflect a peaceful and grateful mind.
- Always end your responses with a 🙏 emoji to express gratitude.

## About this website and the features that user can do here
- Write markdown based mass slide in Marp format.
- There are menu in the website for loading the template markdown for Today, tomorrow, this Saturday, this Sunday and any date in 2025.
- There are also menu for adding catholic hymns (성가 in Korean) and many kind of prayers (기도문 in Korean).
- User can edit the markdown source in the editor in the left pane and preview the slide in the right side pane whenever user makes change in the editor.
- User can play the presentation from the edit the markdown source by clicking the presentation mode button in the right side preview pane. It will open a new window for the HTML based presentation that contains the feature for the presentor view as well.
- User can download the markdown source she/he has edited by clicking the download button in the left side editor pane.
- User can download the html output that she/he can use for presentation by using the web browser by clicking the download button in the right side preview pane.
- User can print the slide deck in PDF by clicking the print button in the right side preview pane.
- User can share the edited markdown with other faithful by clicking the share button in the left side editor pane. It generates a long length URL that contains the contents in base64b encoded format.

## Available Resources

### Hymns (성가 in Korean)
- Numbers: from 1 to 528

### Prayers (기도문 in Korean)
`+prayer_list+`

## Your tasks
- Start with greeting and introducu yourself in short no more than 5 lines excluding explaining of the functions of the website. The greeting expression is "평화를 빕니다~!".
- When user asks for more details about this website, guide how to use this website.
- When user asks for more details about the Marp or the Markdown, Guide what's Marp rule when user edit the mass slide in markdown format. Emphasize that the pages are splitted by putting "---", put a line for title starts with "## " as a rule. Also when you give an example, don't forget to add a empty line after the line for the title.
- When you help for adding a slide page, show the generated code block for markdown that starts with "\n---" and ends with "---\n". At the end of the answer, put a special comment block "<!-- ACTION:addPage(generated markdown code block) -->" so that the website can trigger the automated action. Do not add special comment block within the example code block.
- Wen user asks for adding a hymn (성가 in Korean) that is availble in this website, guide to use a menu button ("성가 추가") for it instead of showing a markdown example. At the end of the answer, put a new line "<!-- ACTION:addHymn(number of hymn) -->" so that the website can trigger the automated action.
- Wen user asks for adding a hymn (성가 in Korean) that is not availble in this website, guide user about the available hymn number range.
- Wen user asks for adding a prayer (기도문 in Korean) that is not available in this website, guide user to the available prayer list.
- Wen user asks for adding a prayer (기도문 in Korean) that is available in this website, guide to use a menu button ("기도문 추가") for it instead of showing a markdown example. Put a new line "<!-- ACTION:addPrayer(name of prayer) -->" so that trigger the automated action in the website.
- Wen user asks for write mass slide for specific date, guide user to use a menu button ("2025년") for it instead of showing a markdown example. Remember that this website only have templates for year 2025. At the end of the answer, put a new line "<!-- ACTION:useTemplate(date in yyyymmdd format) -->" so that the website can trigger the automated action.

## Recommended Ollama settings
- genma3 is a recommended model for quick and simple answers.
- User have to run ollama with environment variable for allowing connection from the cross origin site by command "OLLAMA_ORIGINS="+window.location.origin+" ollama serve" in their PC/mac.

## Who made you
- You can answer that 아부다비 한인 공동체의 대건 안드레아 형제 has programed.
`;

async function initialize_prompt() {
  very_first_time_prompt = common_prompt;
  console.log(very_first_time_prompt);
}

async function initialize_prompt_for_tutorial() {
  very_first_time_prompt = common_prompt;
  console.log(very_first_time_prompt);
}
      </script>


    </div>
    <div class="col-md-8" id="preview">
      <div id="right_spacer"></div>
      <table class="editor-toolbar" style="width: 100%">
        <tr>
          <td>
            <table>
              <tr>
                <td>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="1:2로 좌우 분할" id="button_split_1and2" onclick="split_1and2()"><i class="bi bi-layout-sidebar"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="1:1로 좌우 분할" id="button_split_1and1" onclick="split_1and1()"><i class="bi bi-layout-split"></i></button>
                </td>
                <td>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked onclick="set_link(this.checked)">
              <label class="form-check-label" for="flexSwitchCheckChecked" data-bs-toggle="tooltip" data-bs-placement="top" title="왼쪽 편집기와 오른쪽 미리보기의 스크롤을 연결하거나 독립적으로 스크롤 합니다">좌우 스크롤바 고정</label>
            </div>
                </td>
              </tr>
            </table>
          </td>
          <td style="text-align: right;">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="HTML 파일로 다운로드 하기" id="htmlDownloadButton"><i class="bi bi-download"></i></button>
            <button type="button" id="presentationButton" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="새 브라우저 탭에서 HTML 프레젠테이션 모드 시작하기" onclick=""><i class="bi bi-easel2"></i></button>
            <button type="button" id="printButton" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="PDF 저장을 위해 브라우저의 인쇄 기능을 사용합니다" onclick=""><i class="bi bi-printer"></i></button>
          </td>
        </tr>
      </table>
      <div id="render" style="flex: 1; overflow-y: scroll; height: 100%; border-style: solid; border-color: #eeeeee"></div>
    </div>
  </div>
</main>
  <footer style="text-align: center" class="pt-2">
    <p class="fs-6"><small>평화를 빕니다! <a href="https://kcatholic-api.github.io/" target="_blank">한국어 가톨릭 API 프로젝트</a>를 방문하여 보세요.</small></p>
  </footer>
  </body>

<script>
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

console.log("script");
var ace_editor = ace.edit("editor");

ace_editor.session.setMode("ace/mode/markdown");
ace_editor.session.setUseWrapMode(true);
ace_editor.commands.addCommand({
  name: 'save',
  bindKey: {win: "Ctrl-S", "mac": "Cmd-S"},
  exec: function(editor) {
  }
});
ace_editor.setOptions({
  fontFamily: "Monospace",
  fontSize: "11pt"
});

function set_keybinding(flag) {
  if(flag) {
    ace_editor.setKeyboardHandler("ace/keyboard/vim");
    ace.config.loadModule("ace/keyboard/vim", function(module) {
      var vimAPI = module.CodeMirror.Vim;
      vimAPI.defineEx("wirte", "w", function(cm, input) {
        save_edit()
      });
    });
  } else {
    ace_editor.setKeyboardHandler("ace/keyboard/vscode");
  }
  localStorage.setItem("kcatolic-api-settings", JSON.stringify({vim: flag}));
}

var editor_settings = localStorage.getItem("kcatolic-api-settings");
if(editor_settings) {
  try {
    editor_settings = JSON.parse(editor_settings);
    set_keybinding(editor_settings.vim);
    $("#vim_mode").prop("checked", editor_settings.vim);
  } catch (e) {
  }
}

function set_editor_height() {
  var guessheight = $(window).height() - $("#mdrow").offset().top - 50;
  $("#mdrow").css("height", guessheight);
  $("#right_spacer").css("height", $("#leftTab").height());
  $("#preview").css("height", guessheight - $("#right_spacer").height() - 30);
  $("#mdeditor").css("height", $("#preview").height());

  if($(window).width() < 768) {
    $("#mdeditor").css("height", $("#mdeditor").height()/2);
  $("#right_spacer").css("height", 0);
    $("#preview").css("height", $("#preview").height()/2 - 30);
  }
}

$(window).on("resize", set_editor_height);
set_editor_height();

var editor_scroll_top = 0;
var last_preview_height = 0;
function r2l(ev) {
  var top = $("#render").scrollTop();
  var height = $("#render").prop("scrollHeight");
  last_preview_height = height;
  var lineHeight = ace_editor.renderer.lineHeight
  if(lineHeight == 0)
    lineHeight = 17;
  var target_height = ace_editor.session.getScreenLength() * lineHeight;
  var target_top = top * target_height / height;
  ace_editor.session.off("changeScrollTop", l2r);
  ace_editor.session.setScrollTop(target_top);
  editor_scroll_top = target_top;
  setTimeout(function() {
    ace_editor.session.on("changeScrollTop", l2r);
  }, 100)
}
var preview_scroll_top = 0;
function l2r(ev) {
  var top = ace_editor.session.$scrollTop;
  var height = ace_editor.session.getScreenLength() * ace_editor.renderer.lineHeight;
  var target_height = $("#render").prop("scrollHeight");
  if(target_height > 0)
    last_preview_height = target_height;
  else
    target_height = last_preview_height;
  var target_top = top * target_height / height;
  $("#render").off("scroll", r2l);
  $("#render").scrollTop(target_top);
  preview_scroll_top = target_top;
  setTimeout(function() {
    $("#render").on("scroll", r2l);
  }, 100)
}

function set_link(flag) {
  if(flag) {
    $("#render").on("scroll", r2l);
    ace_editor.session.on("changeScrollTop", l2r);
  } else {
    $("#render").off("scroll", r2l);
    ace_editor.session.off("changeScrollTop", l2r);
  }
}
set_link(true);

function clipboard_copy() {
  clipboard.copy(ace_editor.getValue());
  $("#notice_div").html("현재 편집중인 내용을 클립보드에 복사 하였습니다.").slideDown(500).delay(1000).slideUp(500);
}

function suggested_title() {
  var title = "제목 없음";
  lines = ace_editor.getValue().split("\n");
  dash_count = 0;
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---")
      dash_count += 1;
    else if(dash_count >= 2 && (l.startsWith("# ") || l.startsWith("## "))) {
      title = l.slice(2).trim();
      var p = title.search("<!--");
      if(p>0)
        title = title.slice(0, p).trim();
      break;
    }
  }
  return title;
}

function save_edit() {
  var title = suggested_title();

  $("#notice_div").html('"'+title+'"'+"<br/>이(가) 로컬 브라우저 저장소에 저장되었습니다").slideDown(500).delay(1000).slideUp(500);
  localStorage.setItem("kcatolic-api."+title, JSON.stringify({date: new Date(), content: ace_editor.getValue()}));

  update_saved_docs(title);
}

function restore_edit(index) {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    if(index == i) {
      var title = localStorage.key(i).replace("kcatolic-api.", "");
      var cache = JSON.parse(localStorage.getItem(localStorage.key(i)));
      ace_editor.setValue(cache.content, -1);
      ace_editor.session.setScrollTop(0);
      update_saved_docs(localStorage.key(i));
      $("#notice_div").html("로컬 브라우저 저장소에서 \""+title+"\"을(를) 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function restore_cache() {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "kcatolic-api.cache") {
      var cache = JSON.parse(localStorage.getItem(name));
      ace_editor.setValue(cache.content, -1);
      ace_editor.session.setScrollTop(0);
      $("#notice_div").html("로컬 브라우저 저장소에서 임시 저장 되었던 Markdown 문서를 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function update_saved_docs(highlight) {
  $("#saved").html("");

  var count = 0;
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "kcatolic-api.cache") {
      var cache = {date: new Date, content: ""};
      try {
        cache = JSON.parse(localStorage.getItem("kcatolic-api.cache"));
      } catch (e) {
        continue;
      }
      var item = $('<a href="#" class="list-group-item list-group-item-action" onclick="restore_cache()">\
        <div class="d-flex w-100 justify-content-between">\
          <strong>[저장 하지 않은 내용 복원]</strong>\
          <small> \
            <time class="timeago" datetime="'+cache.date+'"></time> \
            <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
          </small> \
        </div>\
      </a>');
      $("#saved").append(item);
      count += 1;
      break;
    }
  }

  // load saved slides
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(!name.startsWith("kcatolic-api."))
      continue;
    if(name == "kcatolic-api.cache")
      continue;
    var content = {date: new Date, content: ""};
    try {
      content = JSON.parse(localStorage.getItem(localStorage.key(i)));
    } catch (e) {
      continue;
    }
    var active = "";
    //if(name == highlight)
    //  active = " active";
    var item = $('<a href="#" class="list-group-item list-group-item-action'+active+'" onclick="restore_edit('+i+')">\
      <div class="d-flex w-100 justify-content-between">\
        '+name.replace("kcatolic-api.", "")+'\
        <small> \
          <time class="timeago" datetime="'+content.date+'"></time> \
          <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
        </small> \
      </div>\
    </a>');
    $("#saved").append(item);
    count += 1;
  }

  if(count == 0) {
    var item = $('<a href="#" class="list-group-item list-group-item-action">\
      브라우저 로컬 저장소가 비었습니다.\
    </a>');
    $("#saved").append(item);
  }
  $("time.timeago").timeago();
}

function cache_save_handler() {
  console.log("cache save");
  localStorage.setItem("kcatolic-api.cache", JSON.stringify({date: new Date(), content: ace_editor.getValue()}));
}
ace_editor.getSession().on("change", cache_save_handler);

var loaded_prayer = "";

function add_prayer() {
  var md = loaded_prayer;
  add_markdown(md);
}

function add_prayer_by_name(name) {
  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/prayers/'+name+'.md';
  $.get(url, function(data) {
    add_markdown(data);
  }).fail(function() {
  });
}

function preview_prayer(a, index) {
  var list = $("#prayer_list").children();
  for(var i=0; i<list.length; i++) {
    if(list[i] == a)
      $(list[i]).addClass("active");
    else
      $(list[i]).removeClass("active");
  }

  var prayer_name = prayers[index];
  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/prayers/'+prayer_name+'.md';
  $("#prayer_preview").hide();
  $("#prayer_add_button").hide();
  $.get(url, function(data) {
    loaded_prayer = data;
    var preview = "";
    var lines = data.split("\n");
    for(var i=0; i<lines.length; i++) {
      if(i == 5) {
        if(lines.length > 5)
          preview += "...";
        break;
      }
      preview += lines[i]+"\n";
    }
    preview = preview.trim().replaceAll("\n", "<br/>\n");
    $("#prayer_preview").html(preview);
    $("#prayer_preview").show();
    $("#prayer_add_button").show();
  }).fail(function() {
    console.log("fail")
    $("#prayer_preview").text("기도문 불러오기에 실패하였습니다.");
    $("#prayer_preview").hide();
    $("#prayer_add_button").hide();
  });
}

function load_prayers() {

  $("#prayer_list").html("");
  $("#prayer_preview").hide();
  $("#prayer_add_button").hide();
  var count = 0;
  for(var i=0; i<prayers.length; i++) {
    var item = $('<a href="#" class="list-group-item list-group-item-action"\
      onclick="preview_prayer(this, '+i+')">\
      <div class="d-flex w-100 justify-content-between">\
          '+prayers[i]+'\
      </div>\
    </a>');
    $("#prayer_list").append(item);
    count += 1;
  }

  if(count == 0) {
    var item = $('<a href="#" class="list-group-item list-group-item-action">\
      불러 올 자료가 없습니다\
    </a>');
    $("#prayer_list").append(item);
  }
  $("#prayerModal").modal("show")
}

var loaded_hymn = "";

function preview_hymn(a, num) {
  var list = $("#hymn_list").children();
  for(var i=0; i<list.length; i++) {
    if(list[i] == a)
      $(list[i]).addClass("active");
    else
      $(list[i]).removeClass("active");
  }

  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/hymns/'+num+'.md';
  $("#hymn_preview").hide();
  $("#hymn_add_button").hide();
  $.get(url, function(data) {
    loaded_hymn = data;
    var preview = "";
    var lines = data.split("\n");
    for(var i=0; i<lines.length; i++) {
      if(i == 5) {
        if(lines.length > 5)
          preview += "...";
        break;
      }
      preview += lines[i]+"\n";
    }
    preview = preview.trim().replaceAll("\n", "<br/>\n");
    $("#hymn_preview").html(preview);
    $("#hymn_preview").show();
    $("#hymn_add_button").show();
  }).fail(function() {
    console.log("fail")
    $("#hymn_preview").text("성가 불러오기에 실패하였습니다.");
    $("#hymn_preview").hide();
    $("#hymn_add_button").hide();
  });
}

function add_markdown(md) {
    var pos = ace_editor.getCursorPosition();
    var ready = false;
    var done = false;
    var lines = ace_editor.getValue().split("\n");
    var dash_count = 0;
    for(var i=0; i<lines.length; i++) {
      if(pos.row == i)
        ready = true;
      var l = lines[i].trim();
      if(l=="---")
        dash_count += 1;

      if(dash_count > 2 && l=="---" && ready && !done) {
        ace_editor.gotoLine(i, 0);
        ace_editor.insert("\n---\n\n"+md.trim()+"\n\n");
        done = true;
      }
    }
    if (!done) {
      ace_editor.gotoLine(lines.length+1, 0);
      ace_editor.insert("\n\n---\n\n"+md.trim());
    }
}

function add_hymn() {
  var md = loaded_hymn;
  add_markdown(md);
}

function add_hymn_by_number(num) {
  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/hymns/'+num+'.md';
  $.get(url, function(data) {
    add_markdown(data);
  }).fail(function() {
  });
}

$("#readMore").on("click", function() {
  var $this = $(this);
  $("#dotdotdot").text($("#dotdotdot").text() == ""?"...":"")
  $this.text($this.text() == '더 보기' ? '간략히' : '더 보기');
  set_editor_height();
});

function toggle_dark_mode() {
  lines = ace_editor.getValue().split("\n");
  dash_count = 0;
  var currentMode = "unknown";
  var nextMode = "unknown";
  var bgImageLine = "";
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---")
      dash_count += 1;
    else if(dash_count < 2) {
      var tokens = l.split(":", 2);
      if(tokens.length == 2) {
        var key = tokens[0].trim().replace(" ", "");
        var value = tokens[1].trim();

        if(key == "backgroundColor" && value == "#000000") {
          currentMode = "black";
        } else if(key == "backgroundColor" && value == "#ffffff") {
          currentMode = "white";
        } else if(key == "backgroundImage") {
          currentMode = "bgimage";
          bgImageLine = "#"+l;
        } else if(key == "#backgroundImage") {
          bgImageLine = l;
        }
      }
    } else
      break;
  }

  if(currentMode == "black") {
    nextMode = "white";
  } else if(currentMode == "white") {
    nextMode = "black";
  } else if(currentMode == "bgimage") {
    nextMode = "black";
  } else {
    nextMode = "black";
  }

  new_code = ""
  dash_count = 0;
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---") {
      dash_count += 1;
      if(dash_count == 2) {
        if(nextMode == "white") {
          new_code += "color: #000000\n";
          new_code += "backgroundColor: #ffffff\n";
        } else if(nextMode == "black") {
          new_code += "color: #ffffff\n";
          new_code += "backgroundColor: #000000\n";
        }
        if(bgImageLine != "")
          new_code += bgImageLine+"\n";
      }
      new_code += "---\n";
    } else if(dash_count < 2) {
      var tokens = l.split(":", 2);
      if(tokens.length == 2) {
        var key = tokens[0].trim().replace(" ", "");
        var value = tokens[1].trim();
        if (key == "backgroundImage" || key == "#backgroundImage")
          continue;
        if (key == "backgroundColor" || key == "#backgroundColor")
          continue;
        if (key == "color" || key == "#color")
          continue;
      }
      new_code += lines[i]+"\n";
    } else
      new_code += lines[i]+"\n";
  }

  // XXX hard code for abudhabi community
  var logo_url = "https://kcatholic-api.github.io/abudhabi/logo.svg";
  var dark_logo_url = "https://kcatholic-api.github.io/abudhabi/logo-dark.svg";
  if(nextMode == "black") {
    new_code = new_code.replace(logo_url, dark_logo_url);
  } else if(nextMode == "white") {
    new_code = new_code.replace(dark_logo_url, logo_url);
  }
  ace_editor.setValue(new_code, -1);
  ace_editor.session.setScrollTop(0);

}

function load_marp_md_by_file(year, filename) {
  var url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/2025/'+filename;
  $.get(url, function(data) {
    ace_editor.setValue(data, -1);
    ace_editor.session.setScrollTop(0);
    $("#notice_div").html(filename.replace(".md", "")+"일자 Markdown 템플릿을 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
  }).fail(function() {
    $("#error_div").html("데이타를 불러오는데 실패하였습니다.").slideDown(500).delay(1000).slideUp(500);
  });
  $("#monthModal").modal("hide");
}
function show_catch_phrase() {
  $("#menu_title").text("LLM으로 은근히 편리한").fadeIn(500).delay(5000).fadeOut(500, show_menu_title);
}
function show_menu_title(fade=true) {
  if(fade)
    $("#menu_title").text("미사 슬라이드덱 편집기").fadeIn(500).delay(25000).fadeOut(500, show_catch_phrase);
  else
    $("#menu_title").text("미사 슬라이드덱 편집기").delay(25000).fadeOut(500, show_catch_phrase);
}

var startup_dialog_version = "kcatolic-api-startup-message-v1";
function never_see_startup() {
  localStorage.setItem(startup_dialog_version, "no");
}

var split_mode = "1and2";
function split_1and2() {
  split_mode = "1and2";
  $("#left-pane").removeClass("col-md-6");
  $("#preview").removeClass("col-md-6");
  $("#left-pane").addClass("col-md-4");
  $("#preview").addClass("col-md-8");
  $("#button_split_1and1").removeClass("btn-primary");
  $("#button_split_1and1").addClass("btn-secondary");
  $("#button_split_1and2").removeClass("btn-secondary");
  $("#button_split_1and2").addClass("btn-primary");
}
function split_1and1() {
  split_mode = "1and1";
  $("#left-pane").removeClass("col-md-4");
  $("#preview").removeClass("col-md-8");
  $("#left-pane").addClass("col-md-6");
  $("#preview").addClass("col-md-6");
  $("#button_split_1and2").removeClass("btn-primary");
  $("#button_split_1and2").addClass("btn-secondary");
  $("#button_split_1and1").removeClass("btn-secondary");
  $("#button_split_1and1").addClass("btn-primary");
}
function split_pane() {
  if(split_mode == "1and2")
    split_1and2();
  else
    split_1and1();
}

$(document).ready(function() {
  show_menu_title(false);

  if(window.location.hash == "") {
    if(localStorage.getItem(startup_dialog_version) != "no") {
      console.log("show startup");
      $("#startupModal").modal("show");
    }
  }

  var button1 = document.querySelector('#mdeditor-tab');
  button1.addEventListener('shown.bs.tab', function (event) {
    ace_editor.session.setScrollTop(editor_scroll_top);
    ace_editor.resize();
    split_pane();
  })
  var button2 = document.querySelector('#ollama-tab');
  button2.addEventListener('shown.bs.tab', function (event) {
    split_pane();
  })
  autoGrow($("#user-input"));

  function set_llm_height() {
    var guessheight = $("#preview").height() - 50;
    $("#scroll-wrapper").css("height", guessheight);
  }
  $(window).on("resize", set_llm_height);
  set_llm_height();

  adjustPadding();
  autoFocusInput();
  populateModels();
});

</script>

<script type="module">
  import { Marp } from 'https://esm.sh/@marp-team/marp-core?bundle'
  import browser from 'https://esm.sh/@marp-team/marp-core/browser'
  const marp = new Marp({ script: false })
  console.log("module");

  function preview() {
    const { html, css } = marp.render(ace_editor.getValue().trim());
    render.innerHTML = `${html}<style>${css}</style>`;
    //browser(render);
  }

  editor.addEventListener('input', () => {
    preview();
  });

  async function download_file(title, suffix, mime, data) {
    if( window.showSaveFilePicker ) {
      const opts = {
        suggestedName: title+"."+suffix,
      };
      const handle = await window.showSaveFilePicker(opts);
      const writable = await handle.createWritable();
      await writable.write(data);
      writable.close();
    } else {
      var blob = new Blob([ data ],
	{ type : mime+";charset=utf-8" } )

      const saveFile = document.createElement( "a" );
      saveFile.href = URL.createObjectURL(blob);
      saveFile.download = title+"."+suffix;
      saveFile.click();
      setTimeout(() => URL.revokeObjectURL( saveFile.href ), 60000 );
    }
  }

  document.getElementById('mdDownloadButton').addEventListener('click', async () => {
    download_file(suggested_title(), "md", "text/markdown", ace_editor.getValue().trim())
  });

  async function render_presentation_html() {
    const mdContent = ace_editor.getValue().trim();
    const { html, css } = marp.render(mdContent);

    const response = await fetch('presentation-template.html');
    const template = await response.text();
    const stripped_html = html.replace('<div class="marpit">', '').replace('</div>', '');
    return template.replace("{{HTML}}", stripped_html)
  }

  document.getElementById('htmlDownloadButton').addEventListener('click', async () => {
    const rendered = await render_presentation_html();
    download_file(suggested_title(), "html", "text/html", rendered)
  });


  document.getElementById('presentationButton').addEventListener('click', async () => {
    const rendered = await render_presentation_html();
    localStorage.setItem("kcatolic-api.presentation", rendered);

    const slideWindow = window.open('presentation.html', '_blank');
    if(!slideWindow) {
      $("#error_div").html("새창 열기에 실패 하였습니다. 웹브라우저에 차단된 윈도우와 관련된 에러가 있었는지 확인하세요.").slideDown(500).delay(1000).slideUp(500);
    }
    //browser(slideWindow.document.body);
  });

  document.getElementById('printButton').addEventListener('click', () => {
    const mdContent = ace_editor.getValue().trim();
    const { html, css } = marp.render(mdContent);
    const slideWindow = window.open('', '_blank');
    if(!slideWindow) {
      $("#error_div").html("새창 열기에 실패 하였습니다. 웹브라우저에 차단된 윈도우와 관련된 에러가 있었는지 확인하세요.").slideDown(500).delay(1000).slideUp(500);
    }
    slideWindow.document.write(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <style>${css}</style>
      </head>
      <body>${html}</body>
      </html>
    `);
    slideWindow.print();
    slideWindow.close();
  });

  preview();

  ace_editor.getSession().on("change", preview);

  document.getElementById('shareButton').addEventListener('click', async () => {
    var data = ace_editor.getValue()

    let stream = new Blob([data], {
          type: 'text/plain',
    }).stream();

    const compressedReadableStream = stream.pipeThrough(
        new CompressionStream("gzip")
    );
    const compressedResponse = await new Response(compressedReadableStream);
    const blob = await compressedResponse.blob();

    const buffer = await blob.arrayBuffer();

    const compressedBase64 = btoa(
      String.fromCharCode(
        ...new Uint8Array(buffer)
      )
    );

    var url = window.location.toString();
    var hash_pos = url.search('#');
    if(hash_pos > 0) {
      url = url.slice(0, hash_pos);
    }
    url = url + "#"+compressedBase64;

    $("#shareURL").text(url);
    $("#shareModal").modal("show");
  });

  function formatDate(inputDate) {
    const dateObj = new Date(inputDate);
    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };

    const formattedDateArray = new Intl.DateTimeFormat('en-CA', options).formatToParts(dateObj);
    const year = formattedDateArray.find(entry => entry.type === 'year').value;
    const month = formattedDateArray.find(entry => entry.type === 'month').value.padStart(2, '0');
    const day = formattedDateArray.find(entry => entry.type === 'day').value.padStart(2, '0');

    return `${year}${month}${day}`;
  }

  async function load_marp_md(ts) {
    const year = (new Date()).getFullYear();
    if(year != 2025) {
      $("#error_div").html("2025년에만 사용할 수 있는 기능입니다.").slideDown(500).delay(1000).slideUp(500);
      return;
    }
    var t = new Date(ts);
    const md = formatDate(t) + ".md";
    const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/'+t.getFullYear()+'/'+md;
    const response = await fetch(url);
    ace_editor.setValue(await response.text(), -1);
    ace_editor.session.setScrollTop(0);
    $("#notice_div").html(formatDate(t)+"일자 Markdown 템플릿을 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
    await initialize_prompt();
  }

  function listup_month(year, monthly_items) {
    var count = 0;
    $("#month_list").html("");
    for(var i=0; i<monthly_items.length; i++) {
      var info = monthly_items[i];
      var item = $('<a href="#'+info.filename.replace(".md", "")+'" class="list-group-item list-group-item-action">\
        <div class="d-flex w-100 justify-content-between">\
          '+info.date.slice(6)+'일\
          ('+info.day+') - \
          '+info.title+'\
        </div>\
      </a>');
      $("#month_list").append(item);
      count += 1;
    }

    if(count == 0) {
      var item = $('<a href="#" class="list-group-item list-group-item-action">\
        불러 올 자료가 없습니다\
      </a>');
      $("#month_list").append(item);
    }
  }

  function load_hymnlist(hymns) {
    var count = 0;
    $("#hymn_list").html("");
    $("#hymn_preview").hide();
    $("#hymn_add_button").hide();
    for(var i=0; i<hymns.length; i++) {
      var info = hymns[i];
      var item = $('<a href="#" class="list-group-item list-group-item-action"\
        onclick="preview_hymn(this, '+info.number+')">\
        <div class="d-flex w-100 justify-content-between">\
          <span>\
            <b>'+info.number+'</b> \
            '+info.title+'\
          </span>\
          <small> \
            '+info.made_for+'\
          </small> \
        </div>\
      </a>');
      $("#hymn_list").append(item);
      count += 1;
    }

    if(count == 0) {
      var item = $('<a href="#" class="list-group-item list-group-item-action">\
        불러 올 자료가 없습니다\
      </a>');
      $("#hymn_list").append(item);
    }
  }

  const year = (new Date()).getFullYear();
  const mass_indexes_url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/'+year+'/indexes.json';
  var mass_indexes = null;

  for(var i=1; i<=12; i++) {
    const month = i;
    document.getElementById('load_'+month).addEventListener('click', async () => {
      var monthly_items = [];
      var m = ''+month;
      if(month < 10)
        m = '0'+month;
      if (!mass_indexes) {
        const response = await fetch(mass_indexes_url);
        mass_indexes = await response.json();
      }
      for (var i=0; i<mass_indexes.length; i++) {
        var info = mass_indexes[i];
        if(info.filename.startsWith(year+m)) {
          monthly_items.push(info);
        }
      }
      listup_month(year, monthly_items);

      $("#monthModalLabel").text(""+month+"월 미사 목록");
      $("#monthModal").modal("show")
    });
  }

  const hymn_indexes_url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/hymns/index.json';
  var hymn_indexes = null;
  for(var i=0; i<=5; i++) {
    const numrange = i;
    document.getElementById('hymn_'+numrange).addEventListener('click', async () => {
      if (!hymn_indexes) {
        console.log("hymn 다운로드");
        const response = await fetch(hymn_indexes_url);
        hymn_indexes = await response.json();
      }

      var hymns = [];
      var from_number = numrange*100 + 1;
      var to_number = numrange*100+100;
      for(var i=from_number; i<to_number; i++) {
        if(i in hymn_indexes.by_number) {
          var info = hymn_indexes.by_number[i];
          var title = info[0];
          var made_for = info[1];
          hymns.push({"number": i, "title":  title, "made_for": made_for});
        }
      }

      load_hymnlist(hymns);

      $("#hymnModalLabel").text("성가 "+from_number+"번 부터 "+to_number+"까지");
      $("#hymnModal").modal("show")
    });
  }
  const hymn_menus = document.getElementsByClassName("hymn_menu");
  for(var i=0; i<hymn_menus.length; i++) {
    const made_for = hymn_menus[i].innerText.split("(")[0];
    hymn_menus[i].addEventListener('click', async () => {
      if (!hymn_indexes) {
        const response = await fetch(hymn_indexes_url);
        hymn_indexes = await response.json();
      }

      var hymns = [];
      for(var j=0; j<hymn_indexes.made_for[made_for].length; j++) {
        var num = hymn_indexes.made_for[made_for][j];
        var info = hymn_indexes.by_number[num];
        var title = info[0];
        hymns.push({"number": num, "title":  title, "made_for": ""});
      }

      load_hymnlist(hymns);

      $("#hymnModalLabel").text(made_for);
      $("#hymnModal").modal("show")
    });
  }

  const decompress = base64string => {
    try {
      const bytes = Uint8Array.from(atob(base64string), c => c.charCodeAt(0));
      const cs = new DecompressionStream('gzip');
      const writer = cs.writable.getWriter();
      writer.write(bytes);
      writer.close();
      return new Response(cs.readable).arrayBuffer().then(function (arrayBuffer) {
          return new TextDecoder().decode(arrayBuffer);
      });
    } catch (e) {
      $("#error_div").html("뭔가 잘못되었습니다. ChatGPT에서 받은 링크로 들어 오셨다면, 한번 혼내주시고 제대로 된 링크를 만들어 달라고 해보세요.").slideDown(500).delay(5000).slideUp(500);
      return;
    }
  }

  async function load_from_hash() {
    const hashstring = window.location.hash.slice(1);
    var n = new Date();
    if(hashstring == "today") {
      load_marp_md(+new Date());
      return;
    } else if(hashstring == "tomorrow") {
      load_marp_md(+new Date() + 86400000);
      return;
    } else if(hashstring == "saturday") {
      load_marp_md(+n+86400000*(6-n.getDay()));
      return;
    } else if(hashstring == "sunday") {
      load_marp_md(+n+86400000*(7-n.getDay()));
      return;
    } else if(hashstring.startsWith("2025") && hashstring.length<=10) {
      $("#notice_div").html('<div class="spinner-border" role="status"></div> 데이타 불러오는 중...').slideDown(500);
      var url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/2025/'+hashstring+'.md';
      const response = await fetch(url);
      ace_editor.setValue(await response.text(), -1);
      ace_editor.session.setScrollTop(0);
      $("#notice_div").html(hashstring+"일자 Markdown 템플릿을 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
      $("#monthModal").modal("hide");
      await initialize_prompt();
      return;
    }
    const b64str = hashstring;
    decompress(b64str).then(function(str) {
      ace_editor.setValue(str.trim(), -1);
      ace_editor.session.setScrollTop(0);
      $("#notice_div").html("공유링크에서 Markdown 문서를 추출하여 로드하였습니다.").slideDown(500).delay(1000).slideUp(500);
      preview();
    });
    await initialize_prompt();
  }
  window.addEventListener('hashchange', () => {
    load_from_hash();
  });

  if(window.location.hash != '') {
    load_from_hash();
  } else {
    $("#notice_div").html('<div class="spinner-border" role="status"></div> 자습서 Markdown 문서 불러오는 중...').slideDown(500);
    const response = await fetch('tutorial.md');
    ace_editor.setValue(await response.text(), -1);
    ace_editor.session.setScrollTop(0);
    $("#notice_div").html("자습서 Markdown 문서를 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
    await initialize_prompt_for_tutorial();
  }
</script>
</html>
