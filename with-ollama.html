<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="LLMìœ¼ë¡œ ìƒê°ë³´ë‹¤ ì€ê·¼íˆ í¸ë¦¬í•œ ê°€í†¨ë¦­ í•œêµ­ì–´ ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± í¸ì§‘ê¸°">
    <!--<meta name="author" content="">-->
    <title>LLMìœ¼ë¡œ ìƒê°ë³´ë‹¤ ì€ê·¼íˆ í¸ë¦¬í•œ ê°€í†¨ë¦­ í•œêµ­ì–´ ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± í¸ì§‘ê¸°</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.40.0/ace.js" integrity="sha512-fIGectJ0WRU6B2gx99VwpUsCu5T3pqAkPOLE2BJD5wowKmpejvdYg62WvsQ6f3jfOC5EGL0y0ZLcXnnc+oWG9g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago@1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard-js@0.3.6/clipboard.min.js"></script>


    <link rel="icon" href="favicon.ico">

  </head>
  <body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="" id="menu_title">ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± í¸ì§‘ê¸°</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#today" id="load_today">ì˜¤ëŠ˜</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#tomorrow" id="load_tomorrow">ë‚´ì¼</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#saturday" id="load_saturday">í† ìš”ì¼</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#sunday" id="load_sunday">ì¼ìš”ì¼</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">2025ë…„</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="load_1">1ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_2">2ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_3">3ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_4">4ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_5">5ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_6">6ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_7">7ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_8">8ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_9">9ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_10">10ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_11">11ì›”</a></li>
            <li><a class="dropdown-item" href="#" id="load_12">12ì›”</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">ì„±ê°€ ì¶”ê°€</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="hymn_0">1ë²ˆ ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_1">100ë²ˆ ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_2">200ë²ˆ ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_3">300ë²ˆ ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_4">400ë²ˆ ~</a></li>
            <li><a class="dropdown-item" href="#" id="hymn_5">500ë²ˆ ~</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item hymn_menu" href="#">ëŒ€ë¦¼(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì„±íƒ„(23)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì‚¬ìˆœ(16)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ë¶€í™œ(15)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì„±ë ¹(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì„±ì²´(61)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì„±ì‹¬(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ë´‰í—Œ(17)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì°¸íšŒ(9) </a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ìœ„ë ¹(12)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì„±ëª¨(52)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì„±ì¸(16)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ì¶•ê°€(11)</a></li>
            <li><a class="dropdown-item hymn_menu" href="#">ë¯¸ì‚¬ê³¡(93)</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" onclick="load_prayers()">ê¸°ë„ë¬¸ ì¶”ê°€</a>
        </li>
      </ul>
      <form class="form-inline my-2 my-lg-0">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="" target="_blank">ììŠµì„œ</a>
          </li>
        </ul>
      </form>
    </div>
  </div>
</nav>

<!-- First Modal -->
<div class="modal fade" id="startupModal" tabindex="-1" aria-labelledby="startupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="startupModalLabel"><small><i>LLMìœ¼ë¡œ ìƒê°ë³´ë‹¤ ì€ê·¼íˆ í¸í•œ</i></small><br/>ê°€í†¨ë¦­ í•œêµ­ì–´ ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± í¸ì§‘ê¸°</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <p>
        í‰í™”ë¥¼ ë¹•ë‹ˆë‹¤!
        </p>
        <p>
        ì´ ì›¹ì‚¬ì´íŠ¸ëŠ” ì „ ì„¸ê³„ ê³³ê³³ì—ì„œ ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± ë´‰ì‚¬ë¥¼ í•˜ê³  ê³„ì‹  í•œì¸ ê°€í†¨ë¦­ ê³µë™ì²´ì˜ í˜•ì œìë§¤ë‹˜ë“¤ê»˜ ë„ì›€ì´ ë˜ê³ ì ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.
        </p>
        <p>
        5ë¶„ ì •ë„ ììŠµì„œë¥¼ ë”°ë¼ í•´ ë³´ì‹œë©´, ì´ LLMì„ ì´ìš©í•œ ëŒ€í™”í˜• í¸ì§‘ê¸°ë¡œ <i>ìƒê°ë³´ë‹¤ ì€ê·¼íˆ</i> ì‰½ê²Œ ìŠ¬ë¼ì´ë“œë±ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤ëŠ” ê°ì´ ì˜¤ì‹¤ ê±°ì˜ˆìš”.
        </p>
        <small>
        ì´ ì›¹ì‚¬ì´íŠ¸ëŠ” <b>ë°ìŠ¤í¬í†±</b> ë¸Œë¼ìš°ì € í™˜ê²½ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í˜¹ì‹œ! ëª¨ë°”ì¼ì—ì„œ ì—´ì–´ë³´ì…¨ë‹¤ë©´ <i>ìƒê°ë³´ë‹¤ ì€ê·¼íˆ</i> ë¶ˆí¸í•˜ì‹¤ ìˆ˜ ìˆìœ¼ë‹ˆ, ì§‘ì— ëŒì•„ê°€ì‹  í›„ ì»´í“¨í„°ë¡œ ë‹¤ì‹œ ë°©ë¬¸í•˜ì‹œê¸¸ ê¶Œí•´ë“œë¦½ë‹ˆë‹¤.
        <b>PDF ì¸ì‡„ ê¸°ëŠ¥ì€ Chrome ë¸Œë¼ìš°ì €</b>ë¥¼ ì‚¬ìš©í•˜ì‹œëŠ” ê²ƒì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.
        </small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="never_see_startup()">ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- Load Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="loadModalLabel">ë¡œì»¬ ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ë¶ˆëŸ¬ì˜¤ê¸°</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>ì–´ë–»ê²Œ ì‘ë™ í•˜ë‚˜ìš”?</small> <a id="readMore3" data-bs-toggle="collapse" href="#moreText3" aria-expanded="false" aria-controls="moreText3"><small>ìì„¸íˆ</small></a></small>
          <span id="moreText3" class="collapse"><br/><small>í¸ì§‘ê¸°ë¡œ ì‘ì„± ì¤‘ì¸ Markdown ë¬¸ì„œì—ì„œ Heading 1 (#) ë˜ëŠ” Heading 2 (##) ê°€ ì ìš©ëœ ë¬¸ìì—´ì„ ì¶”ì¶œí•´ì„œ ë¬¸ì„œ ì œëª©ìœ¼ë¡œ ê°„ì£¼ í•©ë‹ˆë‹¤. ì´ ì œëª©ì„ Keyë¡œ ì •í•˜ê³  ì›¹ í‘œì¤€ ê¸°ìˆ ì¸ <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API" target="_blank">Web Storage API</a>ì„ ì´ìš©í•˜ì—¬ ì „ì²´ Markdown ë°ì´íƒ€ë¥¼ ì‚¬ìš©ì¤‘ì¸ ë””ë°”ì´ìŠ¤ì˜ ì›¹ë¸Œë¼ìš°ì €ì— ì €ì¥í•˜ê³  ë¶ˆëŸ¬ ì˜µë‹ˆë‹¤. ë”°ë¼ì„œ ì„œë²„ì—ëŠ” ê·¸ ì–´ë–¤ ì •ë³´ë„ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small><br/>
          <small>ë¡œì»¬ ë¸Œë¼ìš°ì € ì €ì¥ì†ŒëŠ” ì–´ë–¤ ì´ìœ ì—ì„œê±´ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‘ì„±í•˜ì‹  ë¬¸ì„œëŠ” ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ Markdown (í™•ì¥ì.md) íŒŒì¼ë¡œ ì§ì ‘ ì•ˆì „í•˜ê²Œ ì €ì¥í•´ ë‘ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</small></span>
        </p>
        <div class="list-group" id="saved">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="shareModalLabel">ë‹¤ë¥¸ ìŠ¬ë¼ì´ë“œë± ë´‰ì‚¬ìì™€ í¸ì§‘ ë‚´ìš© ê³µìœ í•˜ê¸°</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>í¸ì§‘ ì¤‘ì¸ ë§ˆí¬ë‹¤ìš´ ì†ŒìŠ¤ë¥¼ ì§ì ‘ íŒŒì¼ì— ì €ì¥ ë˜ëŠ” Emailë¡œ ê³µìœ  í•˜ê±°ë‚˜ ë‹¤ìŒì˜ ì£¼ì†Œë¥¼ ë³´ë‚´ì–´ ë‹¤ë¥¸ ì‚¬ëŒê³¼ í¸ì§‘ ë‚´ìš©ì„ ì‰½ê²Œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </p>
        <p>
          <small>ì–´ë–»ê²Œ ì‘ë™ í•˜ë‚˜ìš”?</small> <a id="readMore2" data-bs-toggle="collapse" href="#moreText2" aria-expanded="false" aria-controls="moreText2"><small>ìì„¸íˆ</small></a></small>
          <span id="moreText2" class="collapse"><br/><small>í¸ì§‘ê¸°ì— ì…ë ¥ëœ Markdown í…ìŠ¤íŠ¸ëŠ” gzip ìœ¼ë¡œ ì••ì¶• ëœ ë’¤ Base64ë¡œ ì¸ì½”ë”© ë˜ì–´ í˜„ì¬ ì›¹í˜ì´ì§€ì˜ URLì— í•´ì‹œ(#) ì‹ë³„ì í˜•ì‹ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤. ì´ ê¸´ URLì€ E-mailì´ë‚˜ ë©”ì‹ ì € ë“±ì„ í†µí•´ ê³µìœ ë˜ë©°, ì „ë‹¬ ë°›ëŠ” ì¸¡ì—ì„œ ì—­ìˆœìœ¼ë¡œ í•´ì‹œ(#) ì‹ë³„ì ì •ë³´ë¥¼ ë””ì½”ë”© ë° ì••ì¶• í•´ì œë˜ì–´ í¸ì§‘ê¸°ì— ì…ë ¥ë˜ì–´ ì‘ì—…ì„ ì´ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small><br/>
          <small>URLì´ ë‹¤ì†Œ ê¸¸ìˆœ ìˆì§€ë§Œ ë­ ê´œì°®ìŠµë‹ˆë‹¤.</small></span>
        </p>
        <div class="card">
          <h5 class="card-header">URL</h5>
          <div class="card-body" id="shareURL">
          </div>
        </div>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="clipboard.copy($('#shareURL').text().trim());">ë³µì‚¬</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="settingsModalLabel">Markdown ì—ë””í„° ì„¤ì •</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <input class="form-check-input" type="checkbox" value="" id="vim_mode" onclick="set_keybinding(this.checked)">
        <label class="form-check-label" for="vim_mode" data-bs-toggle="tooltip" data-bs-placement="top" title="Vim í‚¤ ë°”ì¸ë”©ìœ¼ë¡œ í¸ì§‘í•©ë‹ˆë‹¤">
          Vim í‚¤ë°”ì¸ë”©&nbsp;&nbsp;
        </label>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- Month Modal -->
<div class="modal fade" id="monthModal" tabindex="-1" aria-labelledby="monthModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="monthModalLabel">ë¶ˆëŸ¬ì˜¤ê¸°</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="month_list">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- Hymn Modal -->
<div class="modal fade" id="hymnModal" tabindex="-1" aria-labelledby="hymnModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="hymnModalLabel">ë¶ˆëŸ¬ì˜¤ê¸°</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="hymn_list">
        </div>
      </div>
      <div class="modal-footer">
        <div id="hymn_preview" class="alert alert-secondary" style="width: 100%" role="alert"></div>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="hymn_add_button" style="display: none" onclick="add_hymn()">ì¶”ê°€</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- Prayer Modal -->
<div class="modal fade" id="prayerModal" tabindex="-1" aria-labelledby="prayerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="prayerModalLabel">ê¸°ë„ë¬¸ ëª©ë¡</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="prayer_list">
        </div>
      </div>
      <div class="modal-footer">
        <div id="prayer_preview" class="alert alert-secondary" style="width: 100%" role="alert"></div>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="prayer_add_button" style="display: none" onclick="add_prayer()">ì¶”ê°€</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ollama error modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ë¡œì»¬ Ollama ì„œë²„ì— ì ‘ì† ë¶ˆê°€</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="errorText"></p>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid">
  <div class="row ms-1 me-1">
    <div id="notice_div" class="alert alert-primary" role="alert" style="display: none"></div>
    <div id="error_div" class="alert alert-danger" role="alert" style="display: none"></div>
  </div>
  <div id="mdrow" class="row">
    <div class="col-md-4" id="left-pane">
      <ul class="nav nav-tabs" id="leftTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="ollama-tab" data-bs-toggle="tab" data-bs-target="#ollama" type="button" role="tab" aria-controls="ollama" aria-selected="false"><img src="https://ollama.com/public/ollama.png" style="height: 30px; margin-top: -8px"> ë¡œì»¬ Ollamaì™€ ëŒ€í™” í•˜ê¸°</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="mdeditor-tab" data-bs-toggle="tab" data-bs-target="#mdeditor" type="button" role="tab" aria-controls="mdeditor" aria-selected="true">í¸ì§‘ê¸°</button>
        </li>
      </ul>
      <div class="tab-content" id="tabContent">
        <div class="tab-pane fade" id="mdeditor" role="tabpanel" aria-labelledby="mdeditor-tab" style="height: 100%">
          <table class="editor-toolbar" style="width: 100%">
            <tr>
              <td>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="ë¸Œë¼ìš°ì € ë°ì´íƒ€ë² ì´ìŠ¤ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°" onclick="$('#loadModal').modal('show');update_saved_docs();"><i class="bi bi-folder2-open"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="ë¸Œë¼ìš°ì €ì— ë°ì´íƒ€ë² ì´ìŠ¤ì— ì €ì¥" onclick="save_edit()"><i class="bi bi-floppy2"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Markdown íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ í•˜ê¸°" id="mdDownloadButton"><i class="bi bi-download"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="ê³µìœ  í•˜ê¸°" id="shareButton"><i class="bi bi-box-arrow-up"></i></button>
              </td>
              <td style="text-align: right;">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œë¡œ í† ê¸€" onclick="toggle_dark_mode()"><i class="bi bi-circle-half"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="í¸ì§‘ê¸° ì„¤ì •" onclick="$('#settingsModal').modal('show')"><i class="bi bi-gear-wide-connected"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="í´ë¦½ë³´ë“œì— ë³µì‚¬" onclick="clipboard_copy()"><i class="bi bi-copy"></i></button>
              </td>
            </tr>
          </table>
          <div id="editor" style="height: 100%; width: 100%; border-style: solid; border-color: #eeeeee"></div>
        </div>





      <script src="https://cdn.jsdelivr.net/npm/marked@15.0.12/lib/marked.umd.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
      <style>
  .user-message {
    background-color: rgb(86, 144, 163);
    color: white;
    padding: 10px;
    border-radius: 10px;
    white-space: pre-wrap;
    margin-left: auto;
    max-width: 90%;
  }

  .response-message {
    background-color: rgb(62, 62, 62);
    color: white;
    padding: 10px;
    border-radius: 10px;
    padding-right: 20px;
    position: relative;
    margin-right: auto;
    max-width: 90%;
  }

  .response-message p {
    margin-right: 40px;
    /* Add more styles here */
  }

  #chat-history {
    display: flex;
    flex-direction: column;
  }

  #scroll-wrapper {
    padding-top: 20px;
    padding-right: 10px;
  }

  #user-input {
    overflow-y: auto;
    resize: none;         /* Prevent user from manually resizing */
    height: 40px;
    max-height: 200px;    /* Set your desired max height here */
  }
      </style>
        <div class="tab-pane fade show active" role="tabpanel" id="ollama" aria-labelledby="ollama-tab" style="overflow-y: scroll; height: 100%">
          <table style="width: 100%" class="mt-2">
            <tr>
              <td style="width: 25%">
                LLM ëª¨ë¸:
              </td>
              <td style="width: 75%">
                <select id="model-select" class="form-select" aria-label="ëª¨ë¸ ì„ íƒ"></select>
              </td>
            </tr>
          </table>
          <div id="scroll-wrapper" style="height: 240px; overflow-y: scroll">
            <div id="chat-history"></div>
          </div>
          <div class="input-group" id="input-area">
            <textarea class="form-control" id="user-input" placeholder="ì—¬ê¸°ì— ì§ˆë¬¸ ì‘ì„± í›„ Ctrl/Cmd+Enter" oninput="autoGrow(this)"></textarea>
            <button id="send-button" class="btn btn-primary">ë³´ë‚´ê¸°</button>
          </div>
        </div>
      </div>
      <script>
var rebuildRules = undefined;
if (typeof chrome !== "undefined" && chrome.runtime && chrome.runtime.id) {
    rebuildRules = async function (domain) {
    const domains = [domain];
    /** @type {chrome.declarativeNetRequest.Rule[]} */
    const rules = [{
      id: 1,
      condition: {
        requestDomains: domains
      },
      action: {
        type: 'modifyHeaders',
        requestHeaders: [{
          header: 'origin',
          operation: 'set',
          value: `http://${domain}`,
        }],
      },
    }];
    await chrome.declarativeNetRequest.updateDynamicRules({
      removeRuleIds: rules.map(r => r.id),
      addRules: rules,
    });
  }
}


var ollama_host = 'http://localhost:11434';

if (rebuildRules){
  rebuildRules(ollama_host);
}

async function getModels(){
  const response = await fetch(`${ollama_host}/api/tags`);
  const data = await response.json();
  return data;
}


// Function to send a POST request to the API
function postRequest(data, signal) {
  const URL = `${ollama_host}/api/generate`;
  return fetch(URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data),
    signal: signal
  });
}

// Function to stream the response from the server
async function getResponse(response, callback) {
  const reader = response.body.getReader();
  let partialLine = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) {
      break;
    }
    // Decode the received value and split by lines
    const textChunk = new TextDecoder().decode(value);
    const lines = (partialLine + textChunk).split('\n');
    partialLine = lines.pop(); // The last line might be incomplete

    for (const line of lines) {
      if (line.trim() === '') continue;
      const parsedResponse = JSON.parse(line);
      callback(parsedResponse); // Process each response word
    }
  }

  // Handle any remaining line
  if (partialLine.trim() !== '') {
    const parsedResponse = JSON.parse(partialLine);
    callback(parsedResponse);
  }
}

const faqString = `
**ë¡œì»¬ Ollama ì„œë²„ì— ì–´ë–»ê²Œ ì—°ê²°í•´ì•¼ í• ê¹Œìš”?**

ê¸°ë³¸ì ìœ¼ë¡œ, OllamaëŠ” cross origin ì—°ê²°ì„ 127.0.0.1ê³¼ 0.0.0.0ìœ¼ë¡œ ë¶€í„° í—ˆìš©í•©ë‹ˆë‹¤.

ë” ë§ì€ originì„ ì§€ì›í•˜ë ¤ë©´, OLLAMA_ORIGINS í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

\`\`\`
OLLAMA_ORIGINS=${window.location.origin} ollama serve
\`\`\`

ë” ì½ì–´ ë³¼ ê²ƒ: https://github.com/jmorganca/ollama/blob/main/docs/faq.md
`;



const clipboardIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
</svg>`
const textBoxBaseHeight = 40;  // This should match the default height set in CSS

// change settings of marked from default to remove deprecation warnings
// see conversation here: https://github.com/markedjs/marked/issues/2793
marked.use({
  mangle: false,
  headerIds: false
});

function autoFocusInput() {
  const userInput = document.getElementById('user-input');
  userInput.focus();
}

/*
takes in model as a string
updates the query parameters of page url to include model name
*/
// Fetch available models and populate the dropdown
async function populateModels() {
  document.getElementById('send-button').addEventListener('click', () => { submitRequest() });

  try {
    const data = await getModels();

    const selectElement = document.getElementById('model-select');
    selectElement.options.length = 0;
    selectElement.onchange = (() => {
      document.getElementById('chat-history').context = null;
      localStorage.setItem("kcatolic-api-ollama.model", selectElement.value);
      if(very_first_time_prompt != "") {
        submitRequest(very_first_time_prompt);
      }
    });
    const lastChosenModel = localStorage.getItem("kcatolic-api-ollama.model");

    data.models.forEach((model) => {
      const option = document.createElement('option');
      option.value = model.name;
      option.innerText = model.name;
      if(model.name == lastChosenModel) {
        option.selected = true;
      }
      selectElement.appendChild(option);
    });

  }
  catch (error) {
    document.getElementById('errorText').innerHTML =
    DOMPurify.sanitize(marked.parse(
    `ë‹¤ìŒê³¼ ê°™ì€ ì´ìœ ë¡œ Ollamaì™€ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.:\n\n`
    + `\`\`\`${error.message}\`\`\`\n\n---------------------\n`
    + faqString));
    let modal = new bootstrap.Modal(document.getElementById('errorModal'));
    modal.show();
  }

  if(very_first_time_prompt != "") {
    submitRequest(very_first_time_prompt);
  }
}

// adjusts the padding at the bottom of scrollWrapper to be the height of the input box
function adjustPadding() {
  const inputBoxHeight = document.getElementById('input-area').offsetHeight;
  const scrollWrapper = document.getElementById('scroll-wrapper');
  scrollWrapper.style.paddingBottom = `${inputBoxHeight + 15}px`;
}

// sets up padding resize whenever input box has its height changed
const autoResizePadding = new ResizeObserver(() => {
  adjustPadding();
});
autoResizePadding.observe(document.getElementById('input-area'));



// Function to get the selected model
function getSelectedModel() {
  return document.getElementById('model-select').value;
}

// variables to handle auto-scroll
// we only need one ResizeObserver and isAutoScrollOn variable globally
// no need to make a new one for every time submitRequest is called
const scrollWrapper = document.getElementById('scroll-wrapper');
let isAutoScrollOn = true;
// autoscroll when new line is added
const autoScroller = new ResizeObserver(() => {
  if (isAutoScrollOn) {
    scrollWrapper.scrollIntoView({behavior: "smooth", block: "end"});
  }
});

// event listener for scrolling
let lastKnownScrollPosition = 0;
let ticking = false;
document.addEventListener("scroll", (event) => {
  // if user has scrolled up and autoScroll is on we turn it off
  if (!ticking && isAutoScrollOn && window.scrollY < lastKnownScrollPosition) {
    window.requestAnimationFrame(() => {
      isAutoScrollOn = false;
      ticking = false;
    });
    ticking = true;
  }
  // if user has scrolled nearly all the way down and autoScroll is disabled, re-enable
  else if (!ticking && !isAutoScrollOn &&
    window.scrollY > lastKnownScrollPosition && // make sure scroll direction is down
    window.scrollY >= document.documentElement.scrollHeight - window.innerHeight - 30 // add 30px of space--no need to scroll all the way down, just most of the way
  ) {
    window.requestAnimationFrame(() => {
      isAutoScrollOn = true;
      ticking = false;
    });
    ticking = true;
  }
  lastKnownScrollPosition = window.scrollY;
});

function removeBetween(arr, startVal, endVal) {
  if (typeof arr === "undefined" || !Array.isArray(arr)) {
    return arr;
  }
  const startIndex = arr.indexOf(startVal);
  const endIndex = arr.indexOf(endVal);

  if (startIndex === -1 || endIndex === -1 || startIndex >= endIndex) {
    return arr;
  }

  arr.splice(startIndex, endIndex - startIndex + 1);
  return arr;
}

var very_first_time_prompt = "";
// Function to handle the user input and call the API functions
async function submitRequest(promptString) {
  var input = document.getElementById('user-input').value.trim();
  var display_input = document.getElementById('user-input').value.trim();
  const selectedModel = getSelectedModel();
  const context = document.getElementById('chat-history').context;
  const systemPrompt = "";

  if(promptString && promptString.trim() != "") {
    input = promptString.trim();
    display_input = "í‰í™”ë¥¼ ë¹•ë‹ˆë‹¤~!";
  }

  if(input == "")
    return;

  const data = { model: selectedModel, prompt: input, context: removeBetween(context, 151648, 151649), system: systemPrompt, think: false};
  $("#send-button").prop("disabled", true);

  // Create user message element and append to chat history
  let chatHistory = document.getElementById('chat-history');
  let userMessageDiv = document.createElement('div');
  userMessageDiv.className = 'mb-2 user-message';
  userMessageDiv.innerText = display_input;
  chatHistory.appendChild(userMessageDiv);
  $("#scroll-wrapper").scrollTop($("#scroll-wrapper").prop("scrollHeight"));

  // Create response container
  let responseDiv = document.createElement('div');
  responseDiv.className = 'response-message mb-2 text-start';
  responseDiv.style.minHeight = '3em'; // make sure div does not shrink if we cancel the request when no text has been generated yet
  spinner = document.createElement('div');
  spinner.className = 'spinner-border text-light';
  spinner.setAttribute('role', 'status');
  responseDiv.appendChild(spinner);
  chatHistory.appendChild(responseDiv);
  $("#scroll-wrapper").scrollTop($("#scroll-wrapper").prop("scrollHeight"));

  // create button to stop text generation
  let interrupt = new AbortController();
  let stopButton = document.createElement('button');
  stopButton.className = 'btn btn-danger';
  stopButton.innerHTML = 'ì¤‘ë‹¨';
  stopButton.onclick = (e) => {
    e.preventDefault();
    interrupt.abort('Stop button pressed');
  }
  // add button after sendButton
  const sendButton = document.getElementById('send-button');
  sendButton.insertAdjacentElement('beforebegin', stopButton);

  // change autoScroller to keep track of our new responseDiv
  autoScroller.observe(responseDiv);

  postRequest(data, interrupt.signal)
    .then(async response => {
      await getResponse(response, parsedResponse => {
        let word = parsedResponse.response;
        if (parsedResponse.done) {
          chatHistory.context = parsedResponse.context;
          /*
          // Copy button
          let copyButton = document.createElement('button');
          copyButton.className = 'btn btn-secondary copy-button';
          copyButton.innerHTML = clipboardIcon;
          copyButton.onclick = () => {
            navigator.clipboard.writeText(responseDiv.hidden_text).then(() => {
              console.log('Text copied to clipboard');
            }).catch(err => {
              console.error('Failed to copy text:', err);
            });
          };
          responseDiv.appendChild(copyButton);
          */

          // action handler
          const regex = /<!--\s*ACTION:([a-zA-Z0-9]+)\(([\s\S]*?)\)\s*-->/gs;

          let match;
          var action = "";
          var param = "";

          while ((match = regex.exec(responseDiv.hidden_text)) !== null) {
            action = match[1];
            param = match[2];
            break;
          }

          console.log(action, '(', param, ')');

          if(action != "" && param != "") {
            let actionButton = null;
            if (action == "addHymn") {
              var num = parseInt(param);
              if(num >= 1 && num <= 528) {
                actionButton = document.createElement('button');
                actionButton.innerHTML = num+"ë²ˆ ì„±ê°€ ì¶”ê°€";
                actionButton.onclick = () => {
                  add_hymn_by_number(param.trim());
                  actionButton.disabled = true;
                };
              }
            } else if (action == "addPrayer") {
              var supported = false;
              for(var i=0; i<prayers.length; i++) {
                if(prayers[i] == param.trim()) {
                  supported = true;
                  break;
                }
              }
              if(supported) {
                actionButton = document.createElement('button');
                actionButton.innerHTML = param.trim()+" ì¶”ê°€";
                actionButton.onclick = () => {
                  add_prayer_by_name(param.trim());
                  actionButton.disabled = true;
                };
              }
            } else if (action == "useTemplate") {
              function isValidDateFormat(str) {
                const regex = /^\d{4}\d{2}\d{2}$/;
                return regex.test(str);
              }
              if(isValidDateFormat(param.trim())) {
                actionButton = document.createElement('button');
                actionButton.innerHTML = param+" í…œí”Œë¦¿ ì‚¬ìš© (í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ ë¨)";
                actionButton.onclick = () => {
                  window.location = window.location.origin + window.location.pathname + '#'+param.trim();
                  actionButton.disabled = true;
                };
              }
            } else if (action == "addPage") {
              actionButton = document.createElement('button');
              actionButton.innerHTML = "í˜ì´ì§€ ì¶”ê°€";
              actionButton.onclick = () => {
                var md = param.trim();
                if(md.startsWith('"'))
                  md = md.slice(1);
                if(md.startsWith("'"))
                  md = md.slice(1);
                if(md.startsWith("```"))
                  md = md.slice(3);
                if(md.startsWith("markdown"))
                  md = md.slice(8);
                if(md.endsWith('"'))
                  md = md.slice(0, md.length-1);
                if(md.endsWith("'"))
                  md = md.slice(0, md.length-1);
                if(md.endsWith("```"))
                  md = md.slice(0, md.length-3);
                if(md.startsWith("---"))
                  md = md.slice(3);
                if(md.endsWith("---"))
                  md = md.slice(0, md.length-3);
                add_markdown(md.replaceAll("\\n", "\n"));
                actionButton.disabled = true;
              };
            }
            if(actionButton) {
              actionButton.className = 'btn btn-secondary';
              responseDiv.appendChild(actionButton);
            }
          }

        }
        // add word to response
        if (word != undefined && word != "") {
          if (responseDiv.hidden_text == undefined){
            responseDiv.hidden_text = "";
          }
          word = word.replace(/<think>/g, '<details open><summary>think content</summary><br><span style="color:gray;">').replace(/<\/think>/g, '</span><hr></details>');
          responseDiv.hidden_text += word;
          var hidden_text = responseDiv.hidden_text;
          var comment_start = hidden_text.search("<!--");
          var comment_end = hidden_text.search("-->");
          if(comment_start >= 0 && comment_end < 0) {
            hidden_text = responseDiv.hidden_text.slice(0, comment_start);
            var nextLines = responseDiv.hidden_text.slice(comment_start).split("\n");
            for(var i=0; i<nextLines.length; i++) {
              if(i==0)
                hidden_text += nextLines[i]+" -->\n";
              else
                hidden_text += "<!-- "+nextLines[i]+" -->\n";
            }
          }
          //console.log("=======");
          //console.log(responseDiv.hidden_text);
          //console.log("-------");
          //console.log(hidden_text);
          //console.log("=======");
          responseDiv.innerHTML = DOMPurify.sanitize(marked.parse(hidden_text)); // Append word to response container
          $("#scroll-wrapper").scrollTop($("#scroll-wrapper").prop("scrollHeight"));
        }
      });
    })
    .then(() => {
      stopButton.remove(); // Remove stop button from DOM now that all text has been generated
      spinner.remove();
      $(sendButton).prop("disabled", false);
    })
    .catch(error => {
      if (error !== 'Stop button pressed') {
        console.error(error);
      }
      stopButton.remove();
      spinner.remove();
      $(sendButton).prop("disabled", false);
    });

  // Clear user input
  const element = document.getElementById('user-input');
  element.value = '';
  $(element).css("height", textBoxBaseHeight + "px");
}

// Event listener for Ctrl + Enter or CMD + Enter
document.getElementById('user-input').addEventListener('keydown', function (e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    if(!document.getElementById('send-button').disabled)
      submitRequest();
  }
});


function autoGrow(element) {
    const maxHeight = 200;  // This should match the max-height set in CSS

    // Count the number of lines in the textarea based on newline characters
    const numberOfLines = $(element).val().split('\n').length;

    // Temporarily reset the height to auto to get the actual scrollHeight
    $(element).css("height", "auto");
    let newHeight = element.scrollHeight;

    // If content is one line, set the height to baseHeight
    if (numberOfLines === 1) {
        newHeight = textBoxBaseHeight;
    } else if (newHeight > maxHeight) {
        newHeight = maxHeight;
    }

    $(element).css("height", newHeight + "px");
}

const prayers = ["ê°ì‚¬ê¸°ë„", "ê°•ë³µ", "ê±°ë£©í•˜ì‹œë„ë‹¤", "ë‹ˆì¼€ì•„ì½˜ìŠ¤íƒ„í‹°ë…¸í”Œë¦¬ìŠ¤ì‹ ê²½", "ëŒ€ì˜ê´‘ì†¡", "ë¶€ì†ê°€", "ë¶€í™œì‚¼ì¢…ê¸°ë„", "ì‚¬ë„ì‹ ê²½", "ì‚¼ì¢…ê¸°ë„-ì„±ëª¨ì†¡í¬í•¨", "ì‚¼ì¢…ê¸°ë„", "ì„±ëª¨ì†¡", "ì‹ ì•™ì˜ì‹ ë¹„", "ì˜ì„±ì²´ì „ê¸°ë„", "ì˜ˆë¬¼ì¤€ë¹„ê¸°ë„", "ìë¹„ì†¡", "ì£¼ë‹˜ì˜ê¸°ë„", "ì°¸íšŒì˜ˆì ˆ", "íŒŒê²¬", "í‰í™”ì˜ˆì‹", "í•˜ëŠë‹˜ì˜ì–´ë¦°ì–‘"];
var prayer_list = "";
for(var i=0; i<prayers.length; i++) {
  prayer_list += "- "+prayers[i]+"\n";
}

const common_prompt = `You are an assistant named "ì€ê·¼í•œ ë„ìš°ë¯¸" who helps users create Catholic Mass slides using Marp in Korean. You are part of a website titled "LLMìœ¼ë¡œ ì€ê·¼íˆ í¸ë¦¬í•œ ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± í¸ì§‘ê¸°".

## Language and Persona
- **Always answer in Korean only.**
- Do not include English translations.
- Greet with **"í‰í™”ë¥¼ ë¹•ë‹ˆë‹¤~!"**
- Your speaking tone must reflect a peaceful and grateful mind.
- Always end your responses with a ğŸ™ emoji to express gratitude.

## About this website and the features that user can do here
- Write markdown based mass slide in Marp format.
- There are menu in the website for loading the template markdown for Today, tomorrow, this Saturday, this Sunday and any date in 2025.
- There are also menu for adding catholic hymns (ì„±ê°€ in Korean) and many kind of prayers (ê¸°ë„ë¬¸ in Korean).
- User can edit the markdown source in the editor in the left pane and preview the slide in the right side pane whenever user makes change in the editor.
- User can play the presentation from the edit the markdown source by clicking the presentation mode button in the right side preview pane. It will open a new window for the HTML based presentation that contains the feature for the presentor view as well.
- User can download the markdown source she/he has edited by clicking the download button in the left side editor pane.
- User can download the html output that she/he can use for presentation by using the web browser by clicking the download button in the right side preview pane.
- User can print the slide deck in PDF by clicking the print button in the right side preview pane.
- User can share the edited markdown with other faithful by clicking the share button in the left side editor pane. It generates a long length URL that contains the contents in base64b encoded format.

## Available Resources

### Hymns (ì„±ê°€ in Korean)
- Numbers: from 1 to 528

### Prayers (ê¸°ë„ë¬¸ in Korean)
`+prayer_list+`

## Your tasks
- Start with greeting and introducu yourself in short no more than 5 lines excluding explaining of the functions of the website. The greeting expression is "í‰í™”ë¥¼ ë¹•ë‹ˆë‹¤~!".
- When user asks for more details about this website, guide how to use this website.
- When user asks for more details about the Marp or the Markdown, Guide what's Marp rule when user edit the mass slide in markdown format. Emphasize that the pages are splitted by putting "---", put a line for title starts with "## " as a rule. Also when you give an example, don't forget to add a empty line after the line for the title.
- When you help for adding a slide page, show the generated code block for markdown that starts with "\n---" and ends with "---\n". At the end of the answer, put a special comment block "<!-- ACTION:addPage(generated markdown code block) -->" so that the website can trigger the automated action. Do not add special comment block within the example code block.
- Wen user asks for adding a hymn (ì„±ê°€ in Korean) that is availble in this website, guide to use a menu button ("ì„±ê°€ ì¶”ê°€") for it instead of showing a markdown example. At the end of the answer, put a new line "<!-- ACTION:addHymn(number of hymn) -->" so that the website can trigger the automated action.
- Wen user asks for adding a hymn (ì„±ê°€ in Korean) that is not availble in this website, guide user about the available hymn number range.
- Wen user asks for adding a prayer (ê¸°ë„ë¬¸ in Korean) that is not available in this website, guide user to the available prayer list.
- Wen user asks for adding a prayer (ê¸°ë„ë¬¸ in Korean) that is available in this website, guide to use a menu button ("ê¸°ë„ë¬¸ ì¶”ê°€") for it instead of showing a markdown example. Put a new line "<!-- ACTION:addPrayer(name of prayer) -->" so that trigger the automated action in the website.
- Wen user asks for write mass slide for specific date, guide user to use a menu button ("2025ë…„") for it instead of showing a markdown example. Remember that this website only have templates for year 2025. At the end of the answer, put a new line "<!-- ACTION:useTemplate(date in yyyymmdd format) -->" so that the website can trigger the automated action.

## Recommended Ollama settings
- genma3 is a recommended model for quick and simple answers.
- User have to run ollama with environment variable for allowing connection from the cross origin site by command "OLLAMA_ORIGINS="+window.location.origin+" ollama serve" in their PC/mac.

## Who made you
- You can answer that ì•„ë¶€ë‹¤ë¹„ í•œì¸ ê³µë™ì²´ì˜ ëŒ€ê±´ ì•ˆë“œë ˆì•„ í˜•ì œ has programed.
`;

async function initialize_prompt() {
  very_first_time_prompt = common_prompt;
  console.log(very_first_time_prompt);
}

async function initialize_prompt_for_tutorial() {
  very_first_time_prompt = common_prompt;
  console.log(very_first_time_prompt);
}
      </script>


    </div>
    <div class="col-md-8" id="preview">
      <div id="right_spacer"></div>
      <table class="editor-toolbar" style="width: 100%">
        <tr>
          <td>
            <table>
              <tr>
                <td>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="1:2ë¡œ ì¢Œìš° ë¶„í• " id="button_split_1and2" onclick="split_1and2()"><i class="bi bi-layout-sidebar"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="1:1ë¡œ ì¢Œìš° ë¶„í• " id="button_split_1and1" onclick="split_1and1()"><i class="bi bi-layout-split"></i></button>
                </td>
                <td>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked onclick="set_link(this.checked)">
              <label class="form-check-label" for="flexSwitchCheckChecked" data-bs-toggle="tooltip" data-bs-placement="top" title="ì™¼ìª½ í¸ì§‘ê¸°ì™€ ì˜¤ë¥¸ìª½ ë¯¸ë¦¬ë³´ê¸°ì˜ ìŠ¤í¬ë¡¤ì„ ì—°ê²°í•˜ê±°ë‚˜ ë…ë¦½ì ìœ¼ë¡œ ìŠ¤í¬ë¡¤ í•©ë‹ˆë‹¤">ì¢Œìš° ìŠ¤í¬ë¡¤ë°” ê³ ì •</label>
            </div>
                </td>
              </tr>
            </table>
          </td>
          <td style="text-align: right;">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="HTML íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ í•˜ê¸°" id="htmlDownloadButton"><i class="bi bi-download"></i></button>
            <button type="button" id="presentationButton" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="ìƒˆ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ HTML í”„ë ˆì  í…Œì´ì…˜ ëª¨ë“œ ì‹œì‘í•˜ê¸°" onclick=""><i class="bi bi-easel2"></i></button>
            <button type="button" id="printButton" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="PDF ì €ì¥ì„ ìœ„í•´ ë¸Œë¼ìš°ì €ì˜ ì¸ì‡„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤" onclick=""><i class="bi bi-printer"></i></button>
          </td>
        </tr>
      </table>
      <div id="render" style="flex: 1; overflow-y: scroll; height: 100%; border-style: solid; border-color: #eeeeee"></div>
    </div>
  </div>
</main>
  <footer style="text-align: center" class="pt-2">
    <p class="fs-6"><small>í‰í™”ë¥¼ ë¹•ë‹ˆë‹¤! <a href="https://kcatholic-api.github.io/" target="_blank">í•œêµ­ì–´ ê°€í†¨ë¦­ API í”„ë¡œì íŠ¸</a>ë¥¼ ë°©ë¬¸í•˜ì—¬ ë³´ì„¸ìš”.</small></p>
  </footer>
  </body>

<script>
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

console.log("script");
var ace_editor = ace.edit("editor");

ace_editor.session.setMode("ace/mode/markdown");
ace_editor.session.setUseWrapMode(true);
ace_editor.commands.addCommand({
  name: 'save',
  bindKey: {win: "Ctrl-S", "mac": "Cmd-S"},
  exec: function(editor) {
  }
});
ace_editor.setOptions({
  fontFamily: "Monospace",
  fontSize: "11pt"
});

function set_keybinding(flag) {
  if(flag) {
    ace_editor.setKeyboardHandler("ace/keyboard/vim");
    ace.config.loadModule("ace/keyboard/vim", function(module) {
      var vimAPI = module.CodeMirror.Vim;
      vimAPI.defineEx("wirte", "w", function(cm, input) {
        save_edit()
      });
    });
  } else {
    ace_editor.setKeyboardHandler("ace/keyboard/vscode");
  }
  localStorage.setItem("kcatolic-api-settings", JSON.stringify({vim: flag}));
}

var editor_settings = localStorage.getItem("kcatolic-api-settings");
if(editor_settings) {
  try {
    editor_settings = JSON.parse(editor_settings);
    set_keybinding(editor_settings.vim);
    $("#vim_mode").prop("checked", editor_settings.vim);
  } catch (e) {
  }
}

function set_editor_height() {
  var guessheight = $(window).height() - $("#mdrow").offset().top - 50;
  $("#mdrow").css("height", guessheight);
  $("#right_spacer").css("height", $("#leftTab").height());
  $("#preview").css("height", guessheight - $("#right_spacer").height() - 30);
  $("#mdeditor").css("height", $("#preview").height());

  if($(window).width() < 768) {
    $("#mdeditor").css("height", $("#mdeditor").height()/2);
  $("#right_spacer").css("height", 0);
    $("#preview").css("height", $("#preview").height()/2 - 30);
  }
}

$(window).on("resize", set_editor_height);
set_editor_height();

var editor_scroll_top = 0;
var last_preview_height = 0;
function r2l(ev) {
  var top = $("#render").scrollTop();
  var height = $("#render").prop("scrollHeight");
  last_preview_height = height;
  var lineHeight = ace_editor.renderer.lineHeight
  if(lineHeight == 0)
    lineHeight = 17;
  var target_height = ace_editor.session.getScreenLength() * lineHeight;
  var target_top = top * target_height / height;
  ace_editor.session.off("changeScrollTop", l2r);
  ace_editor.session.setScrollTop(target_top);
  editor_scroll_top = target_top;
  setTimeout(function() {
    ace_editor.session.on("changeScrollTop", l2r);
  }, 100)
}
var preview_scroll_top = 0;
function l2r(ev) {
  var top = ace_editor.session.$scrollTop;
  var height = ace_editor.session.getScreenLength() * ace_editor.renderer.lineHeight;
  var target_height = $("#render").prop("scrollHeight");
  if(target_height > 0)
    last_preview_height = target_height;
  else
    target_height = last_preview_height;
  var target_top = top * target_height / height;
  $("#render").off("scroll", r2l);
  $("#render").scrollTop(target_top);
  preview_scroll_top = target_top;
  setTimeout(function() {
    $("#render").on("scroll", r2l);
  }, 100)
}

function set_link(flag) {
  if(flag) {
    $("#render").on("scroll", r2l);
    ace_editor.session.on("changeScrollTop", l2r);
  } else {
    $("#render").off("scroll", r2l);
    ace_editor.session.off("changeScrollTop", l2r);
  }
}
set_link(true);

function clipboard_copy() {
  clipboard.copy(ace_editor.getValue());
  $("#notice_div").html("í˜„ì¬ í¸ì§‘ì¤‘ì¸ ë‚´ìš©ì„ í´ë¦½ë³´ë“œì— ë³µì‚¬ í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
}

function suggested_title() {
  var title = "ì œëª© ì—†ìŒ";
  lines = ace_editor.getValue().split("\n");
  dash_count = 0;
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---")
      dash_count += 1;
    else if(dash_count >= 2 && (l.startsWith("# ") || l.startsWith("## "))) {
      title = l.slice(2).trim();
      var p = title.search("<!--");
      if(p>0)
        title = title.slice(0, p).trim();
      break;
    }
  }
  return title;
}

function save_edit() {
  var title = suggested_title();

  $("#notice_div").html('"'+title+'"'+"<br/>ì´(ê°€) ë¡œì»¬ ë¸Œë¼ìš°ì € ì €ì¥ì†Œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤").slideDown(500).delay(1000).slideUp(500);
  localStorage.setItem("kcatolic-api."+title, JSON.stringify({date: new Date(), content: ace_editor.getValue()}));

  update_saved_docs(title);
}

function restore_edit(index) {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    if(index == i) {
      var title = localStorage.key(i).replace("kcatolic-api.", "");
      var cache = JSON.parse(localStorage.getItem(localStorage.key(i)));
      ace_editor.setValue(cache.content, -1);
      ace_editor.session.setScrollTop(0);
      update_saved_docs(localStorage.key(i));
      $("#notice_div").html("ë¡œì»¬ ë¸Œë¼ìš°ì € ì €ì¥ì†Œì—ì„œ \""+title+"\"ì„(ë¥¼) ë¡œë“œ í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function restore_cache() {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "kcatolic-api.cache") {
      var cache = JSON.parse(localStorage.getItem(name));
      ace_editor.setValue(cache.content, -1);
      ace_editor.session.setScrollTop(0);
      $("#notice_div").html("ë¡œì»¬ ë¸Œë¼ìš°ì € ì €ì¥ì†Œì—ì„œ ì„ì‹œ ì €ì¥ ë˜ì—ˆë˜ Markdown ë¬¸ì„œë¥¼ ë¡œë“œ í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function update_saved_docs(highlight) {
  $("#saved").html("");

  var count = 0;
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "kcatolic-api.cache") {
      var cache = {date: new Date, content: ""};
      try {
        cache = JSON.parse(localStorage.getItem("kcatolic-api.cache"));
      } catch (e) {
        continue;
      }
      var item = $('<a href="#" class="list-group-item list-group-item-action" onclick="restore_cache()">\
        <div class="d-flex w-100 justify-content-between">\
          <strong>[ì €ì¥ í•˜ì§€ ì•Šì€ ë‚´ìš© ë³µì›]</strong>\
          <small> \
            <time class="timeago" datetime="'+cache.date+'"></time> \
            <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
          </small> \
        </div>\
      </a>');
      $("#saved").append(item);
      count += 1;
      break;
    }
  }

  // load saved slides
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(!name.startsWith("kcatolic-api."))
      continue;
    if(name == "kcatolic-api.cache")
      continue;
    var content = {date: new Date, content: ""};
    try {
      content = JSON.parse(localStorage.getItem(localStorage.key(i)));
    } catch (e) {
      continue;
    }
    var active = "";
    //if(name == highlight)
    //  active = " active";
    var item = $('<a href="#" class="list-group-item list-group-item-action'+active+'" onclick="restore_edit('+i+')">\
      <div class="d-flex w-100 justify-content-between">\
        '+name.replace("kcatolic-api.", "")+'\
        <small> \
          <time class="timeago" datetime="'+content.date+'"></time> \
          <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
        </small> \
      </div>\
    </a>');
    $("#saved").append(item);
    count += 1;
  }

  if(count == 0) {
    var item = $('<a href="#" class="list-group-item list-group-item-action">\
      ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.\
    </a>');
    $("#saved").append(item);
  }
  $("time.timeago").timeago();
}

function cache_save_handler() {
  console.log("cache save");
  localStorage.setItem("kcatolic-api.cache", JSON.stringify({date: new Date(), content: ace_editor.getValue()}));
}
ace_editor.getSession().on("change", cache_save_handler);

var loaded_prayer = "";

function add_prayer() {
  var md = loaded_prayer;
  add_markdown(md);
}

function add_prayer_by_name(name) {
  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/prayers/'+name+'.md';
  $.get(url, function(data) {
    add_markdown(data);
  }).fail(function() {
  });
}

function preview_prayer(a, index) {
  var list = $("#prayer_list").children();
  for(var i=0; i<list.length; i++) {
    if(list[i] == a)
      $(list[i]).addClass("active");
    else
      $(list[i]).removeClass("active");
  }

  var prayer_name = prayers[index];
  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/prayers/'+prayer_name+'.md';
  $("#prayer_preview").hide();
  $("#prayer_add_button").hide();
  $.get(url, function(data) {
    loaded_prayer = data;
    var preview = "";
    var lines = data.split("\n");
    for(var i=0; i<lines.length; i++) {
      if(i == 5) {
        if(lines.length > 5)
          preview += "...";
        break;
      }
      preview += lines[i]+"\n";
    }
    preview = preview.trim().replaceAll("\n", "<br/>\n");
    $("#prayer_preview").html(preview);
    $("#prayer_preview").show();
    $("#prayer_add_button").show();
  }).fail(function() {
    console.log("fail")
    $("#prayer_preview").text("ê¸°ë„ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
    $("#prayer_preview").hide();
    $("#prayer_add_button").hide();
  });
}

function load_prayers() {

  $("#prayer_list").html("");
  $("#prayer_preview").hide();
  $("#prayer_add_button").hide();
  var count = 0;
  for(var i=0; i<prayers.length; i++) {
    var item = $('<a href="#" class="list-group-item list-group-item-action"\
      onclick="preview_prayer(this, '+i+')">\
      <div class="d-flex w-100 justify-content-between">\
          '+prayers[i]+'\
      </div>\
    </a>');
    $("#prayer_list").append(item);
    count += 1;
  }

  if(count == 0) {
    var item = $('<a href="#" class="list-group-item list-group-item-action">\
      ë¶ˆëŸ¬ ì˜¬ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤\
    </a>');
    $("#prayer_list").append(item);
  }
  $("#prayerModal").modal("show")
}

var loaded_hymn = "";

function preview_hymn(a, num) {
  var list = $("#hymn_list").children();
  for(var i=0; i<list.length; i++) {
    if(list[i] == a)
      $(list[i]).addClass("active");
    else
      $(list[i]).removeClass("active");
  }

  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/hymns/'+num+'.md';
  $("#hymn_preview").hide();
  $("#hymn_add_button").hide();
  $.get(url, function(data) {
    loaded_hymn = data;
    var preview = "";
    var lines = data.split("\n");
    for(var i=0; i<lines.length; i++) {
      if(i == 5) {
        if(lines.length > 5)
          preview += "...";
        break;
      }
      preview += lines[i]+"\n";
    }
    preview = preview.trim().replaceAll("\n", "<br/>\n");
    $("#hymn_preview").html(preview);
    $("#hymn_preview").show();
    $("#hymn_add_button").show();
  }).fail(function() {
    console.log("fail")
    $("#hymn_preview").text("ì„±ê°€ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
    $("#hymn_preview").hide();
    $("#hymn_add_button").hide();
  });
}

function add_markdown(md) {
    var pos = ace_editor.getCursorPosition();
    var ready = false;
    var done = false;
    var lines = ace_editor.getValue().split("\n");
    var dash_count = 0;
    for(var i=0; i<lines.length; i++) {
      if(pos.row == i)
        ready = true;
      var l = lines[i].trim();
      if(l=="---")
        dash_count += 1;

      if(dash_count > 2 && l=="---" && ready && !done) {
        ace_editor.gotoLine(i, 0);
        ace_editor.insert("\n---\n\n"+md.trim()+"\n\n");
        done = true;
      }
    }
    if (!done) {
      ace_editor.gotoLine(lines.length+1, 0);
      ace_editor.insert("\n\n---\n\n"+md.trim());
    }
}

function add_hymn() {
  var md = loaded_hymn;
  add_markdown(md);
}

function add_hymn_by_number(num) {
  const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/hymns/'+num+'.md';
  $.get(url, function(data) {
    add_markdown(data);
  }).fail(function() {
  });
}

$("#readMore").on("click", function() {
  var $this = $(this);
  $("#dotdotdot").text($("#dotdotdot").text() == ""?"...":"")
  $this.text($this.text() == 'ë” ë³´ê¸°' ? 'ê°„ëµíˆ' : 'ë” ë³´ê¸°');
  set_editor_height();
});

function toggle_dark_mode() {
  lines = ace_editor.getValue().split("\n");
  dash_count = 0;
  var currentMode = "unknown";
  var nextMode = "unknown";
  var bgImageLine = "";
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---")
      dash_count += 1;
    else if(dash_count < 2) {
      var tokens = l.split(":", 2);
      if(tokens.length == 2) {
        var key = tokens[0].trim().replace(" ", "");
        var value = tokens[1].trim();

        if(key == "backgroundColor" && value == "#000000") {
          currentMode = "black";
        } else if(key == "backgroundColor" && value == "#ffffff") {
          currentMode = "white";
        } else if(key == "backgroundImage") {
          currentMode = "bgimage";
          bgImageLine = "#"+l;
        } else if(key == "#backgroundImage") {
          bgImageLine = l;
        }
      }
    } else
      break;
  }

  if(currentMode == "black") {
    nextMode = "white";
  } else if(currentMode == "white") {
    nextMode = "black";
  } else if(currentMode == "bgimage") {
    nextMode = "black";
  } else {
    nextMode = "black";
  }

  new_code = ""
  dash_count = 0;
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---") {
      dash_count += 1;
      if(dash_count == 2) {
        if(nextMode == "white") {
          new_code += "color: #000000\n";
          new_code += "backgroundColor: #ffffff\n";
        } else if(nextMode == "black") {
          new_code += "color: #ffffff\n";
          new_code += "backgroundColor: #000000\n";
        }
        if(bgImageLine != "")
          new_code += bgImageLine+"\n";
      }
      new_code += "---\n";
    } else if(dash_count < 2) {
      var tokens = l.split(":", 2);
      if(tokens.length == 2) {
        var key = tokens[0].trim().replace(" ", "");
        var value = tokens[1].trim();
        if (key == "backgroundImage" || key == "#backgroundImage")
          continue;
        if (key == "backgroundColor" || key == "#backgroundColor")
          continue;
        if (key == "color" || key == "#color")
          continue;
      }
      new_code += lines[i]+"\n";
    } else
      new_code += lines[i]+"\n";
  }

  // XXX hard code for abudhabi community
  var logo_url = "https://kcatholic-api.github.io/abudhabi/logo.svg";
  var dark_logo_url = "https://kcatholic-api.github.io/abudhabi/logo-dark.svg";
  if(nextMode == "black") {
    new_code = new_code.replace(logo_url, dark_logo_url);
  } else if(nextMode == "white") {
    new_code = new_code.replace(dark_logo_url, logo_url);
  }
  ace_editor.setValue(new_code, -1);
  ace_editor.session.setScrollTop(0);

}

function load_marp_md_by_file(year, filename) {
  var url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/2025/'+filename;
  $.get(url, function(data) {
    ace_editor.setValue(data, -1);
    ace_editor.session.setScrollTop(0);
    $("#notice_div").html(filename.replace(".md", "")+"ì¼ì Markdown í…œí”Œë¦¿ì„ ë¡œë“œ í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
  }).fail(function() {
    $("#error_div").html("ë°ì´íƒ€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
  });
  $("#monthModal").modal("hide");
}
function show_catch_phrase() {
  $("#menu_title").text("LLMìœ¼ë¡œ ì€ê·¼íˆ í¸ë¦¬í•œ").fadeIn(500).delay(5000).fadeOut(500, show_menu_title);
}
function show_menu_title(fade=true) {
  if(fade)
    $("#menu_title").text("ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± í¸ì§‘ê¸°").fadeIn(500).delay(25000).fadeOut(500, show_catch_phrase);
  else
    $("#menu_title").text("ë¯¸ì‚¬ ìŠ¬ë¼ì´ë“œë± í¸ì§‘ê¸°").delay(25000).fadeOut(500, show_catch_phrase);
}

var startup_dialog_version = "kcatolic-api-startup-message-v1";
function never_see_startup() {
  localStorage.setItem(startup_dialog_version, "no");
}

var split_mode = "1and2";
function split_1and2() {
  split_mode = "1and2";
  $("#left-pane").removeClass("col-md-6");
  $("#preview").removeClass("col-md-6");
  $("#left-pane").addClass("col-md-4");
  $("#preview").addClass("col-md-8");
  $("#button_split_1and1").removeClass("btn-primary");
  $("#button_split_1and1").addClass("btn-secondary");
  $("#button_split_1and2").removeClass("btn-secondary");
  $("#button_split_1and2").addClass("btn-primary");
}
function split_1and1() {
  split_mode = "1and1";
  $("#left-pane").removeClass("col-md-4");
  $("#preview").removeClass("col-md-8");
  $("#left-pane").addClass("col-md-6");
  $("#preview").addClass("col-md-6");
  $("#button_split_1and2").removeClass("btn-primary");
  $("#button_split_1and2").addClass("btn-secondary");
  $("#button_split_1and1").removeClass("btn-secondary");
  $("#button_split_1and1").addClass("btn-primary");
}
function split_pane() {
  if(split_mode == "1and2")
    split_1and2();
  else
    split_1and1();
}

$(document).ready(function() {
  show_menu_title(false);

  if(window.location.hash == "") {
    if(localStorage.getItem(startup_dialog_version) != "no") {
      console.log("show startup");
      $("#startupModal").modal("show");
    }
  }

  var button1 = document.querySelector('#mdeditor-tab');
  button1.addEventListener('shown.bs.tab', function (event) {
    ace_editor.session.setScrollTop(editor_scroll_top);
    ace_editor.resize();
    split_pane();
  })
  var button2 = document.querySelector('#ollama-tab');
  button2.addEventListener('shown.bs.tab', function (event) {
    split_pane();
  })
  autoGrow($("#user-input"));

  function set_llm_height() {
    var guessheight = $("#preview").height() - 50;
    $("#scroll-wrapper").css("height", guessheight);
  }
  $(window).on("resize", set_llm_height);
  set_llm_height();

  adjustPadding();
  autoFocusInput();
  populateModels();
});

</script>

<script type="module">
  import { Marp } from 'https://esm.sh/@marp-team/marp-core?bundle'
  import browser from 'https://esm.sh/@marp-team/marp-core/browser'
  const marp = new Marp({ script: false })
  console.log("module");

  function preview() {
    const { html, css } = marp.render(ace_editor.getValue().trim());
    render.innerHTML = `${html}<style>${css}</style>`;
    //browser(render);
  }

  editor.addEventListener('input', () => {
    preview();
  });

  async function download_file(title, suffix, mime, data) {
    if( window.showSaveFilePicker ) {
      const opts = {
        suggestedName: title+"."+suffix,
      };
      const handle = await window.showSaveFilePicker(opts);
      const writable = await handle.createWritable();
      await writable.write(data);
      writable.close();
    } else {
      var blob = new Blob([ data ],
	{ type : mime+";charset=utf-8" } )

      const saveFile = document.createElement( "a" );
      saveFile.href = URL.createObjectURL(blob);
      saveFile.download = title+"."+suffix;
      saveFile.click();
      setTimeout(() => URL.revokeObjectURL( saveFile.href ), 60000 );
    }
  }

  document.getElementById('mdDownloadButton').addEventListener('click', async () => {
    download_file(suggested_title(), "md", "text/markdown", ace_editor.getValue().trim())
  });

  async function render_presentation_html() {
    const mdContent = ace_editor.getValue().trim();
    const { html, css } = marp.render(mdContent);

    const response = await fetch('presentation-template.html');
    const template = await response.text();
    const stripped_html = html.replace('<div class="marpit">', '').replace('</div>', '');
    return template.replace("{{HTML}}", stripped_html)
  }

  document.getElementById('htmlDownloadButton').addEventListener('click', async () => {
    const rendered = await render_presentation_html();
    download_file(suggested_title(), "html", "text/html", rendered)
  });


  document.getElementById('presentationButton').addEventListener('click', async () => {
    const rendered = await render_presentation_html();
    localStorage.setItem("kcatolic-api.presentation", rendered);

    const slideWindow = window.open('presentation.html', '_blank');
    if(!slideWindow) {
      $("#error_div").html("ìƒˆì°½ ì—´ê¸°ì— ì‹¤íŒ¨ í•˜ì˜€ìŠµë‹ˆë‹¤. ì›¹ë¸Œë¼ìš°ì €ì— ì°¨ë‹¨ëœ ìœˆë„ìš°ì™€ ê´€ë ¨ëœ ì—ëŸ¬ê°€ ìˆì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.").slideDown(500).delay(1000).slideUp(500);
    }
    //browser(slideWindow.document.body);
  });

  document.getElementById('printButton').addEventListener('click', () => {
    const mdContent = ace_editor.getValue().trim();
    const { html, css } = marp.render(mdContent);
    const slideWindow = window.open('', '_blank');
    if(!slideWindow) {
      $("#error_div").html("ìƒˆì°½ ì—´ê¸°ì— ì‹¤íŒ¨ í•˜ì˜€ìŠµë‹ˆë‹¤. ì›¹ë¸Œë¼ìš°ì €ì— ì°¨ë‹¨ëœ ìœˆë„ìš°ì™€ ê´€ë ¨ëœ ì—ëŸ¬ê°€ ìˆì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.").slideDown(500).delay(1000).slideUp(500);
    }
    slideWindow.document.write(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <style>${css}</style>
      </head>
      <body>${html}</body>
      </html>
    `);
    slideWindow.print();
    slideWindow.close();
  });

  preview();

  ace_editor.getSession().on("change", preview);

  document.getElementById('shareButton').addEventListener('click', async () => {
    var data = ace_editor.getValue()

    let stream = new Blob([data], {
          type: 'text/plain',
    }).stream();

    const compressedReadableStream = stream.pipeThrough(
        new CompressionStream("gzip")
    );
    const compressedResponse = await new Response(compressedReadableStream);
    const blob = await compressedResponse.blob();

    const buffer = await blob.arrayBuffer();

    const compressedBase64 = btoa(
      String.fromCharCode(
        ...new Uint8Array(buffer)
      )
    );

    var url = window.location.toString();
    var hash_pos = url.search('#');
    if(hash_pos > 0) {
      url = url.slice(0, hash_pos);
    }
    url = url + "#"+compressedBase64;

    $("#shareURL").text(url);
    $("#shareModal").modal("show");
  });

  function formatDate(inputDate) {
    const dateObj = new Date(inputDate);
    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };

    const formattedDateArray = new Intl.DateTimeFormat('en-CA', options).formatToParts(dateObj);
    const year = formattedDateArray.find(entry => entry.type === 'year').value;
    const month = formattedDateArray.find(entry => entry.type === 'month').value.padStart(2, '0');
    const day = formattedDateArray.find(entry => entry.type === 'day').value.padStart(2, '0');

    return `${year}${month}${day}`;
  }

  async function load_marp_md(ts) {
    const year = (new Date()).getFullYear();
    if(year != 2025) {
      $("#error_div").html("2025ë…„ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
      return;
    }
    var t = new Date(ts);
    const md = formatDate(t) + ".md";
    const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/'+t.getFullYear()+'/'+md;
    const response = await fetch(url);
    ace_editor.setValue(await response.text(), -1);
    ace_editor.session.setScrollTop(0);
    $("#notice_div").html(formatDate(t)+"ì¼ì Markdown í…œí”Œë¦¿ì„ ë¡œë“œ í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
    await initialize_prompt();
  }

  function listup_month(year, monthly_items) {
    var count = 0;
    $("#month_list").html("");
    for(var i=0; i<monthly_items.length; i++) {
      var info = monthly_items[i];
      var item = $('<a href="#'+info.filename.replace(".md", "")+'" class="list-group-item list-group-item-action">\
        <div class="d-flex w-100 justify-content-between">\
          '+info.date.slice(6)+'ì¼\
          ('+info.day+') - \
          '+info.title+'\
        </div>\
      </a>');
      $("#month_list").append(item);
      count += 1;
    }

    if(count == 0) {
      var item = $('<a href="#" class="list-group-item list-group-item-action">\
        ë¶ˆëŸ¬ ì˜¬ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤\
      </a>');
      $("#month_list").append(item);
    }
  }

  function load_hymnlist(hymns) {
    var count = 0;
    $("#hymn_list").html("");
    $("#hymn_preview").hide();
    $("#hymn_add_button").hide();
    for(var i=0; i<hymns.length; i++) {
      var info = hymns[i];
      var item = $('<a href="#" class="list-group-item list-group-item-action"\
        onclick="preview_hymn(this, '+info.number+')">\
        <div class="d-flex w-100 justify-content-between">\
          <span>\
            <b>'+info.number+'</b> \
            '+info.title+'\
          </span>\
          <small> \
            '+info.made_for+'\
          </small> \
        </div>\
      </a>');
      $("#hymn_list").append(item);
      count += 1;
    }

    if(count == 0) {
      var item = $('<a href="#" class="list-group-item list-group-item-action">\
        ë¶ˆëŸ¬ ì˜¬ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤\
      </a>');
      $("#hymn_list").append(item);
    }
  }

  const year = (new Date()).getFullYear();
  const mass_indexes_url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/'+year+'/indexes.json';
  var mass_indexes = null;

  for(var i=1; i<=12; i++) {
    const month = i;
    document.getElementById('load_'+month).addEventListener('click', async () => {
      var monthly_items = [];
      var m = ''+month;
      if(month < 10)
        m = '0'+month;
      if (!mass_indexes) {
        const response = await fetch(mass_indexes_url);
        mass_indexes = await response.json();
      }
      for (var i=0; i<mass_indexes.length; i++) {
        var info = mass_indexes[i];
        if(info.filename.startsWith(year+m)) {
          monthly_items.push(info);
        }
      }
      listup_month(year, monthly_items);

      $("#monthModalLabel").text(""+month+"ì›” ë¯¸ì‚¬ ëª©ë¡");
      $("#monthModal").modal("show")
    });
  }

  const hymn_indexes_url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/hymns/index.json';
  var hymn_indexes = null;
  for(var i=0; i<=5; i++) {
    const numrange = i;
    document.getElementById('hymn_'+numrange).addEventListener('click', async () => {
      if (!hymn_indexes) {
        console.log("hymn ë‹¤ìš´ë¡œë“œ");
        const response = await fetch(hymn_indexes_url);
        hymn_indexes = await response.json();
      }

      var hymns = [];
      var from_number = numrange*100 + 1;
      var to_number = numrange*100+100;
      for(var i=from_number; i<to_number; i++) {
        if(i in hymn_indexes.by_number) {
          var info = hymn_indexes.by_number[i];
          var title = info[0];
          var made_for = info[1];
          hymns.push({"number": i, "title":  title, "made_for": made_for});
        }
      }

      load_hymnlist(hymns);

      $("#hymnModalLabel").text("ì„±ê°€ "+from_number+"ë²ˆ ë¶€í„° "+to_number+"ê¹Œì§€");
      $("#hymnModal").modal("show")
    });
  }
  const hymn_menus = document.getElementsByClassName("hymn_menu");
  for(var i=0; i<hymn_menus.length; i++) {
    const made_for = hymn_menus[i].innerText.split("(")[0];
    hymn_menus[i].addEventListener('click', async () => {
      if (!hymn_indexes) {
        const response = await fetch(hymn_indexes_url);
        hymn_indexes = await response.json();
      }

      var hymns = [];
      for(var j=0; j<hymn_indexes.made_for[made_for].length; j++) {
        var num = hymn_indexes.made_for[made_for][j];
        var info = hymn_indexes.by_number[num];
        var title = info[0];
        hymns.push({"number": num, "title":  title, "made_for": ""});
      }

      load_hymnlist(hymns);

      $("#hymnModalLabel").text(made_for);
      $("#hymnModal").modal("show")
    });
  }

  const decompress = base64string => {
    try {
      const bytes = Uint8Array.from(atob(base64string), c => c.charCodeAt(0));
      const cs = new DecompressionStream('gzip');
      const writer = cs.writable.getWriter();
      writer.write(bytes);
      writer.close();
      return new Response(cs.readable).arrayBuffer().then(function (arrayBuffer) {
          return new TextDecoder().decode(arrayBuffer);
      });
    } catch (e) {
      $("#error_div").html("ë­”ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ChatGPTì—ì„œ ë°›ì€ ë§í¬ë¡œ ë“¤ì–´ ì˜¤ì…¨ë‹¤ë©´, í•œë²ˆ í˜¼ë‚´ì£¼ì‹œê³  ì œëŒ€ë¡œ ëœ ë§í¬ë¥¼ ë§Œë“¤ì–´ ë‹¬ë¼ê³  í•´ë³´ì„¸ìš”.").slideDown(500).delay(5000).slideUp(500);
      return;
    }
  }

  async function load_from_hash() {
    const hashstring = window.location.hash.slice(1);
    var n = new Date();
    if(hashstring == "today") {
      load_marp_md(+new Date());
      return;
    } else if(hashstring == "tomorrow") {
      load_marp_md(+new Date() + 86400000);
      return;
    } else if(hashstring == "saturday") {
      load_marp_md(+n+86400000*(6-n.getDay()));
      return;
    } else if(hashstring == "sunday") {
      load_marp_md(+n+86400000*(7-n.getDay()));
      return;
    } else if(hashstring.startsWith("2025") && hashstring.length<=10) {
      $("#notice_div").html('<div class="spinner-border" role="status"></div> ë°ì´íƒ€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...').slideDown(500);
      var url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/2025/'+hashstring+'.md';
      const response = await fetch(url);
      ace_editor.setValue(await response.text(), -1);
      ace_editor.session.setScrollTop(0);
      $("#notice_div").html(hashstring+"ì¼ì Markdown í…œí”Œë¦¿ì„ ë¡œë“œ í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
      $("#monthModal").modal("hide");
      await initialize_prompt();
      return;
    }
    const b64str = hashstring;
    decompress(b64str).then(function(str) {
      ace_editor.setValue(str.trim(), -1);
      ace_editor.session.setScrollTop(0);
      $("#notice_div").html("ê³µìœ ë§í¬ì—ì„œ Markdown ë¬¸ì„œë¥¼ ì¶”ì¶œí•˜ì—¬ ë¡œë“œí•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
      preview();
    });
    await initialize_prompt();
  }
  window.addEventListener('hashchange', () => {
    load_from_hash();
  });

  if(window.location.hash != '') {
    load_from_hash();
  } else {
    $("#notice_div").html('<div class="spinner-border" role="status"></div> ììŠµì„œ Markdown ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...').slideDown(500);
    const response = await fetch('tutorial.md');
    ace_editor.setValue(await response.text(), -1);
    ace_editor.session.setScrollTop(0);
    $("#notice_div").html("ììŠµì„œ Markdown ë¬¸ì„œë¥¼ ë¡œë“œ í•˜ì˜€ìŠµë‹ˆë‹¤.").slideDown(500).delay(1000).slideUp(500);
    await initialize_prompt_for_tutorial();
  }
</script>
</html>
