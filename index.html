
<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>한국어 미사 슬라이드덱 편집기</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.40.0/ace.js" integrity="sha512-fIGectJ0WRU6B2gx99VwpUsCu5T3pqAkPOLE2BJD5wowKmpejvdYg62WvsQ6f3jfOC5EGL0y0ZLcXnnc+oWG9g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago@1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard-js@0.3.6/clipboard.min.js"></script>


    <!--<link rel="icon" href="favicon.ico">-->

  </head>
  <body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="">미사 슬라이드덱 편집기</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" id="load_today">오늘</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" id="load_tomorrow">내일</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" id="load_saturday">이번 토요일</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" id="load_sunday">이번 일요일</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">2025년</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="load_1">1월</a></li>
            <li><a class="dropdown-item" href="#" id="load_2">2월</a></li>
            <li><a class="dropdown-item" href="#" id="load_3">3월</a></li>
            <li><a class="dropdown-item" href="#" id="load_4">4월</a></li>
            <li><a class="dropdown-item" href="#" id="load_5">5월</a></li>
            <li><a class="dropdown-item" href="#" id="load_6">6월</a></li>
            <li><a class="dropdown-item" href="#" id="load_7">7월</a></li>
            <li><a class="dropdown-item" href="#" id="load_8">8월</a></li>
            <li><a class="dropdown-item" href="#" id="load_9">9월</a></li>
            <li><a class="dropdown-item" href="#" id="load_10">10월</a></li>
            <li><a class="dropdown-item" href="#" id="load_11">11월</a></li>
            <li><a class="dropdown-item" href="#" id="load_12">12월</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">기도문 추가</a>
          <ul class="dropdown-menu" id="prayer_list">
          </ul>
        </li>
      </ul>
      <!--
      <form class="form-inline my-2 my-lg-0">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="https://marpit.marp.app/markdown" target="_blank">Marpit Markdown 도움말</a>
          </li>
        </ul>
      </form>
      -->
    </div>
  </div>
</nav>

<!-- Load Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="loadModalLabel">로컬 브라우저 저장소 불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>어떻게 작동 하나요?</small> <a id="readMore3" data-bs-toggle="collapse" href="#moreText3" aria-expanded="false" aria-controls="moreText3"><small>자세히</small></a></small>
          <span id="moreText3" class="collapse"><br/><small>편집기로 작성 중인 Markdown 문서에서 Heading 1 (#) 또는 Heading 2 (##) 가 적용된 문자열을 추출해서 문서 제목으로 간주 합니다. 이 제목을 Key로 정하고 웹 표준 기술인 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API" target="_blank">Web Storage API</a>을 이용하여 전체 Markdown 데이타를 사용중인 디바이스의 웹브라우저에 저장하고 불러 옵니다.</small><br/>
          <small>서버에는 그 어떤 정보도 저장되지 않습니다.</small></span>
        </p>
        <div class="list-group" id="saved">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="shareModalLabel">다른 슬라이드덱 봉사자와 편집 내용 공유하기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>편집 중인 마크다운 소스를 직접 파일에 저장 또는 Email로 공유 하거나 다음의 주소를 보내어 다른 사람과 편집 내용을 쉽게 공유할 수 있습니다.</small>
        </p>
        <p>
          <small>어떻게 작동 하나요?</small> <a id="readMore2" data-bs-toggle="collapse" href="#moreText2" aria-expanded="false" aria-controls="moreText2"><small>자세히</small></a></small>
          <span id="moreText2" class="collapse"><br/><small>편집기에 입력된 Markdown 텍스트는 gzip 으로 압축 된 뒤 Base64로 인코딩 되어 현재 웹페이지의 URL에 해시(#) 식별자 형식으로 연결됩니다. 이 긴 URL은 E-mail이나 메신저 등을 통해 공유되며, 전달 받는 측에서 역순으로 해시(#) 식별자 정보를 디코딩 및 압축 해제되어 편집기에 입력되어 작업을 이어갈 수 있습니다.</small><br/>
          <small>URL이 다소 길순 있지만 뭐 괜찮습니다.</small></span>
        </p>
        <div class="card">
          <h5 class="card-header">URL</h5>
          <div class="card-body" id="shareURL">
          </div>
        </div>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="clipboard.copy($('#shareURL').text().trim());">복사</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="settingsModalLabel">Markdown 에디터 설정</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <input class="form-check-input" type="checkbox" value="" id="vim_mode" onclick="set_keybinding(this.checked)">
        <label class="form-check-label" for="vim_mode" data-bs-toggle="tooltip" data-bs-placement="top" title="Vim 키 바인딩으로 편집합니다">
          Vim 키바인딩&nbsp;&nbsp;
        </label>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Month Modal -->
<div class="modal fade" id="monthModal" tabindex="-1" aria-labelledby="monthModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="monthModalLabel">불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="month_list">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>


<main class="container-fluid">
  <div class="row ms-1 me-1">
    <div id="progressdiv" class="alert alert-info" role="alert" style="display: none"></div>
    <div id="alertdiv" class="alert alert-success" role="alert" style="display: none"></div>
    <div id="erroralertdiv" class="alert alert-danger" role="alert" style="display: none"></div>
  </div>
  <div class="row">
    <p><small>이 생각보다 은근히 편리한 미사 슬라이드덱 편집기는 마크다운(Markdown) 문법을 사용하는 <span id="dotdotdot">...</span><span id="moreText" class="collapse">Marpit이라는 오픈소스 도구를 사용하여 천주교 미사를 위한 슬라이드 장표를 깔끔하게 만들어 줄 수 있답니다. 원래 코딩을 해본 경험이 있는 바쁜 교회 봉사자를 위하여 만들어 졌지만, 하느님의 은총으로 당신도 뚝딱 배워서 봉사에 사용할 수 있을 지도 몰라요. 본능에 따라 이것 저것 건드려 보세요. 또는 자세한 문법 설명이 있는 <a href="https://commonmark.org/help/tutorial/" target="_blank">마크다운 자습서</a>와 <a href="https://marpit.marp.app/markdown" target="_blank">Marpit 설명서</a>를 읽어 보신 후 주님의 기도 3번 바쳐보세요.</span> <a id="readMore" data-bs-toggle="collapse" href="#moreText" aria-expanded="false" aria-controls="moreText"><small>더 보기</small></a></small></p>
  </div>
  <div class="row">
    <div class="col-md-6">
      <table style="width: 100%">
        <tr>
          <td>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우저 데이타베이스에서 불러오기" onclick="$('#loadModal').modal('show');update_saved_docs();"><i class="bi bi-folder2-open"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우저에 데이타베이스에 저장" onclick="save_edit()"><i class="bi bi-floppy2"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="클립보드에 복사" onclick="clipboard_copy()"><i class="bi bi-copy"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="공유 하기" id="shareButton"><i class="bi bi-box-arrow-up"></i></button>
          </td>
          <td style="text-align: right;">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="다크/라이트 모드로 토글" onclick="toggle_dark_mode()"><i class="bi bi-circle-half"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="편집기 설정" onclick="$('#settingsModal').modal('show')"><i class="bi bi-gear-wide-connected"></i></button>
          </td>
        </tr>
      </table>
    </div>
    <div class="col-md-6">
      <table style="width: 100%">
        <tr>
          <td>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked onclick="set_link(this.checked)">
              <label class="form-check-label" for="flexSwitchCheckChecked" data-bs-toggle="tooltip" data-bs-placement="top" title="왼쪽 편집기와 오른쪽 미리보기의 스크롤을 연결하거나 독립적으로 스크롤 합니다">스크롤 연결</label>
            </div>
          </div>
          </td>
          <td style="text-align: right;">
            <button type="button" id="presentationButton" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우저를 이용한 HTML 프레젠테이션 모드 시작하기" onclick=""><i class="bi bi-easel2"></i></button>
            <button type="button" id="printButton" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="PDF 저장을 위해 브라우저의 인쇄 기능을 사용합니다" onclick=""><i class="bi bi-printer"></i></button>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div id="mdrow" class="row">
    <div class="col-md-6" id="leftPane" style="overflow-y: scroll; height: 100%">
      <div id="editor" style="height: 100%; width: 100%; border-style: solid; border-color: #eeeeee"></div>
    </div>
    <div id="rightPane" class="col-md-6" style="height: 100%">
      <div id="render" style="flex: 1; overflow-y: scroll; height: 100%; border-style: solid; border-color: #eeeeee"></div>
    </div>
  </div>
</main>
  <footer style="text-align: center" class="pt-2">
    <p class="fs-6"><small>평화를 빕니다! <a href="https://kcatholic-api.github.io/" target="_blank">한국어 카톨릭 API 프로젝트</a>를 방문하여 보세요.</small></p>
  </footer>
  </body>

<script>
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

console.log("script");
var ace_editor = ace.edit("editor");

ace_editor.session.setMode("ace/mode/markdown");
ace_editor.session.setUseWrapMode(true);
ace_editor.commands.addCommand({
  name: 'save',
  bindKey: {win: "Ctrl-S", "mac": "Cmd-S"},
  exec: function(editor) {
  }
});
ace_editor.setOptions({
  fontFamily: "Monospace",
  fontSize: "11pt"
});

function set_keybinding(flag) {
  if(flag) {
    ace_editor.setKeyboardHandler("ace/keyboard/vim");
    ace.config.loadModule("ace/keyboard/vim", function(module) {
      var vimAPI = module.CodeMirror.Vim;
      vimAPI.defineEx("wirte", "w", function(cm, input) {
        save_edit()
      });
    });
  } else {
    ace_editor.setKeyboardHandler("ace/keyboard/vscode");
  }
  localStorage.setItem("kcatolic-api-settings", JSON.stringify({vim: flag}));
}

var editor_settings = localStorage.getItem("kcatolic-api-settings");
if(editor_settings) {
  try {
    editor_settings = JSON.parse(editor_settings);
    set_keybinding(editor_settings.vim);
    $("#vim_mode").prop("checked", editor_settings.vim);
  } catch (e) {
  }
}

function set_editor_height() {
  var guessheight = $(window).height() - $("#mdrow").offset().top - 50;
  $("#mdrow").css("height", guessheight);
  if($(window).width() < 768) {
    $("#leftPane").css("height", "50%");
    $("#rightPane").css("height", "50%");
  } else {
    $("#leftPane").css("height", "100%");
    $("#rightPane").css("height", "100%");
  }
}

$(window).on("resize", set_editor_height);
set_editor_height();

function r2l(ev) {
  var top = $("#render").scrollTop();
  var height = $("#render").prop("scrollHeight");
  var target_height = ace_editor.session.getScreenLength() * ace_editor.renderer.lineHeight;
  var target_top = top * target_height / height;
  ace_editor.session.off("changeScrollTop", l2r);
  ace_editor.session.setScrollTop(target_top);
  setTimeout(function() {
    ace_editor.session.on("changeScrollTop", l2r);
  }, 100)
}
function l2r(ev) {
  var top = ace_editor.session.$scrollTop;
  var height = ace_editor.session.getScreenLength() * ace_editor.renderer.lineHeight;
  var target_height = $("#render").prop("scrollHeight");
  var target_top = top * target_height / height;
  $("#render").off("scroll", r2l);
  $("#render").scrollTop(target_top);
  setTimeout(function() {
    $("#render").on("scroll", r2l);
  }, 100)
}

function set_link(flag) {
  if(flag) {
    $("#render").on("scroll", r2l);
    ace_editor.session.on("changeScrollTop", l2r);
  } else {
    $("#render").off("scroll", r2l);
    ace_editor.session.off("changeScrollTop", l2r);
  }
}
set_link(true);

function clipboard_copy() {
  clipboard.copy(ace_editor.getValue());
  $("#alertdiv").html("현재 편집중인 내용을 클립보드에 복사 하였습니다.").slideDown(500).delay(1000).slideUp(500);
}

function save_edit() {
  var title = "제목 없음";
  lines = ace_editor.getValue().split("\n");
  dash_count = 0;
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---")
      dash_count += 1;
    else if(dash_count >= 2 && (l.startsWith("# ") || l.startsWith("## "))) {
      title = l.slice(2).trim();
      var p = title.search("<!--");
      if(p>0)
        title = title.slice(0, p).trim();
      break;
    }
  }

  $("#alertdiv").html('"'+title+'"'+"<br/>이(가) 로컬 브라우저 저장소에 저장되었습니다").slideDown(500).delay(1000).slideUp(500);
  localStorage.setItem("kcatolic-api."+title, JSON.stringify({date: new Date(), content: ace_editor.getValue()}));

  update_saved_docs(title);
}

function restore_edit(index) {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    if(index == i) {
      var title = localStorage.key(i);
      var cache = JSON.parse(localStorage.getItem(title));
      ace_editor.setValue(cache.content, -1);
      ace_editor.session.setScrollTop(0);
      update_saved_docs(localStorage.key(i));
      $("#alertdiv").html("로컬 브라우저 저장소에서 \""+title+"\"을(를) 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function restore_cache() {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "kcatolic-api.cache") {
      var cache = JSON.parse(localStorage.getItem(name));
      ace_editor.setValue(cache.content, -1);
      ace_editor.session.setScrollTop(0);
      $("#alertdiv").html("로컬 브라우저 저장소에서 임시 저장 되었던 Markdown 문서를 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function update_saved_docs(highlight) {
  $("#saved").html("");

  var count = 0;
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "kcatolic-api.cache") {
      var cache = {date: new Date, content: ""};
      try {
        cache = JSON.parse(localStorage.getItem("kcatolic-api.cache"));
      } catch (e) {
        continue;
      }
      var item = $('<a href="#" class="list-group-item list-group-item-action" onclick="restore_cache()">\
        <div class="d-flex w-100 justify-content-between">\
          <strong>[저장하지 않은 내용 복원]</strong>\
          <small> \
            <time class="timeago" datetime="'+cache.date+'"></time> \
            <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
          </small> \
        </div>\
      </a>');
      $("#saved").append(item);
      count += 1;
      break;
    }
  }

  // load saved slides
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(!name.startsWith("kcatolic-api."))
      continue;
    if(name == "kcatolic-api.cache")
      continue;
    var content = {date: new Date, content: ""};
    try {
      content = JSON.parse(localStorage.getItem(localStorage.key(i)));
    } catch (e) {
      continue;
    }
    var active = "";
    //if(name == highlight)
    //  active = " active";
    var item = $('<a href="#" class="list-group-item list-group-item-action'+active+'" onclick="restore_edit('+i+')">\
      <div class="d-flex w-100 justify-content-between">\
        '+name.replace("kcatolic-api.", "")+'\
        <small> \
          <time class="timeago" datetime="'+content.date+'"></time> \
          <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
        </small> \
      </div>\
    </a>');
    $("#saved").append(item);
    count += 1;
  }

  if(count == 0) {
    var item = $('<a href="#" class="list-group-item list-group-item-action">\
      브라우저 로컬 저장소가 비었습니다.\
    </a>');
    $("#saved").append(item);
  }
  $("time.timeago").timeago();
}

function cache_save_handler() {
  console.log("cache save");
  localStorage.setItem("kcatolic-api.cache", JSON.stringify({date: new Date(), content: ace_editor.getValue()}));
}
ace_editor.getSession().on("change", cache_save_handler);

$("#readMore").on("click", function() {
  var $this = $(this);
  $("#dotdotdot").text($("#dotdotdot").text() == ""?"...":"")
  $this.text($this.text() == '더 보기' ? '간략히' : '더 보기');
  set_editor_height();
});

function toggle_dark_mode() {
  lines = ace_editor.getValue().split("\n");
  dash_count = 0;
  var currentMode = "unknown";
  var nextMode = "unknown";
  var bgImageLine = "";
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---")
      dash_count += 1;
    else if(dash_count < 2) {
      var tokens = l.split(":", 2);
      if(tokens.length == 2) {
        var key = tokens[0].trim().replace(" ", "");
        var value = tokens[1].trim();

        if(key == "backgroundColor" && value == "#000000") {
          currentMode = "black";
        } else if(key == "backgroundColor" && value == "#ffffff") {
          currentMode = "white";
        } else if(key == "backgroundImage") {
          currentMode = "bgimage";
          bgImageLine = "#"+l;
        } else if(key == "#backgroundImage") {
          bgImageLine = l;
        }
      }
    } else
      break;
  }

  if(currentMode == "black") {
    nextMode = "white";
  } else if(currentMode == "white") {
    nextMode = "black";
  } else if(currentMode == "bgimage") {
    nextMode = "black";
  } else {
    nextMode = "black";
  }

  new_code = ""
  dash_count = 0;
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---") {
      dash_count += 1;
      if(dash_count == 2) {
        if(nextMode == "white") {
          new_code += "color: #000000\n";
          new_code += "backgroundColor: #ffffff\n";
        } else if(nextMode == "black") {
          new_code += "color: #ffffff\n";
          new_code += "backgroundColor: #000000\n";
        }
        if(bgImageLine != "")
          new_code += bgImageLine+"\n";
      }
      new_code += "---\n";
    } else if(dash_count < 2) {
      var tokens = l.split(":", 2);
      if(tokens.length == 2) {
        var key = tokens[0].trim().replace(" ", "");
        var value = tokens[1].trim();
        if (key == "backgroundImage" || key == "#backgroundImage")
          continue;
        if (key == "backgroundColor" || key == "#backgroundColor")
          continue;
        if (key == "color" || key == "#color")
          continue;
      }
      new_code += lines[i]+"\n";
    } else
      new_code += lines[i]+"\n";
  }

  // XXX hard code for abudhabi community
  var logo_url = "https://kcatholic-api.github.io/abudhabi/logo.svg";
  var dark_logo_url = "https://kcatholic-api.github.io/abudhabi/logo-dark.svg";
  if(nextMode == "black") {
    new_code = new_code.replace(logo_url, dark_logo_url);
  } else if(nextMode == "white") {
    new_code = new_code.replace(dark_logo_url, logo_url);
  }
  ace_editor.setValue(new_code, -1);
  ace_editor.session.setScrollTop(0);

}

function load_marp_md_by_file(year, filename) {
  var url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/2025/'+filename;
  $.get(url, function(data) {
    ace_editor.setValue(data, -1);
    ace_editor.session.setScrollTop(0);
    $("#alertdiv").html(filename.replace(".md", "")+"의 Markdown 템플릿을 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
  }).fail(function() {
    $("#erroralertdiv").html("데이타를 불러오는데 실패하였습니다.").slideDown(500).delay(1000).slideUp(500);
  });
  $("#monthModal").modal("hide");
}
</script>

<script type="module">
  import { Marp } from 'https://esm.sh/@marp-team/marp-core?bundle'
  import browser from 'https://esm.sh/@marp-team/marp-core/browser'
  const marp = new Marp({ script: false })
  console.log("module");

  function preview() {
    const { html, css } = marp.render(ace_editor.getValue().trim());
    render.innerHTML = `${html}<style>${css}</style>`;
    //browser(render);
  }

  editor.addEventListener('input', () => {
    preview();
  });


  document.getElementById('presentationButton').addEventListener('click', async () => {
    const mdContent = ace_editor.getValue().trim();
    const { html, css } = marp.render(mdContent);

    const response = await fetch('presentation-template.html');
    const template = await response.text();
    const stripped_html = html.replace('<div class="marpit">', '');
    const rendered = template.replace("{{HTML}}", stripped_html)
    localStorage.setItem("kcatolic-api.presentation", rendered);

    const slideWindow = window.open('presentation.html', '_blank');
    if(!slideWindow) {
      $("#erroralertdiv").html("새창 열기에 실패 하였습니다. 웹브라우저에 차단된 윈도우와 관련된 에러가 있었는지 확인하세요.").slideDown(500).delay(1000).slideUp(500);
    }
    //browser(slideWindow.document.body);
  });

  document.getElementById('printButton').addEventListener('click', () => {
    const mdContent = ace_editor.getValue().trim();
    const { html, css } = marp.render(mdContent);
    const slideWindow = window.open('', '_blank');
    if(!slideWindow) {
      $("#erroralertdiv").html("새창 열기에 실패 하였습니다. 웹브라우저에 차단된 윈도우와 관련된 에러가 있었는지 확인하세요.").slideDown(500).delay(1000).slideUp(500);
    }
    slideWindow.document.write(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <style>${css}</style>
      </head>
      <body>${html}</body>
      </html>
    `);
    slideWindow.print();
    slideWindow.close();
  });

  preview();

  ace_editor.getSession().on("change", preview);

  document.getElementById('shareButton').addEventListener('click', async () => {
    var data = ace_editor.getValue()

    let stream = new Blob([data], {
          type: 'text/plain',
    }).stream();

    const compressedReadableStream = stream.pipeThrough(
        new CompressionStream("gzip")
    );
    const compressedResponse = await new Response(compressedReadableStream);
    const blob = await compressedResponse.blob();

    const buffer = await blob.arrayBuffer();

    const compressedBase64 = btoa(
      String.fromCharCode(
        ...new Uint8Array(buffer)
      )
    );

    var url = window.location.toString();
    var hash_pos = url.search('#');
    if(hash_pos > 0) {
      url = url.slice(0, hash_pos);
    }
    url = url + "#"+compressedBase64;

    $("#shareURL").text(url);
    $("#shareModal").modal("show");
  });

  function formatDate(inputDate) {
    const dateObj = new Date(inputDate);
    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };

    const formattedDateArray = new Intl.DateTimeFormat('en-CA', options).formatToParts(dateObj);
    const year = formattedDateArray.find(entry => entry.type === 'year').value;
    const month = formattedDateArray.find(entry => entry.type === 'month').value.padStart(2, '0');
    const day = formattedDateArray.find(entry => entry.type === 'day').value.padStart(2, '0');

    return `${year}${month}${day}`;
  }

  async function load_marp_md(ts) {
    const year = (new Date()).getFullYear();
    if(year != 2025) {
      $("#erroralertdiv").html("2025년에만 사용할 수 있는 기능입니다.").slideDown(500).delay(1000).slideUp(500);
      return;
    }
    var t = new Date(ts);
    const md = formatDate(t) + ".md";
    const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/'+t.getFullYear()+'/'+md;
    const response = await fetch(url);
    ace_editor.setValue(await response.text(), -1);
    ace_editor.session.setScrollTop(0);
    $("#alertdiv").html(formatDate(t)+"의 Markdown 템플릿을 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
  }

  document.getElementById('load_today').addEventListener('click', async () => {
    load_marp_md(+new Date());
  });

  document.getElementById('load_tomorrow').addEventListener('click', async () => {
    load_marp_md(+new Date() + 86400000);
  });

  document.getElementById('load_saturday').addEventListener('click', async () => {
    var n = new Date();
    load_marp_md(+n+86400000*(6-n.getDay()));
  });

  document.getElementById('load_sunday').addEventListener('click', async () => {
    var n = new Date();
    load_marp_md(+n+86400000*(7-n.getDay()));
  });

  function listup_month(year, monthly_items) {
    var count = 0;
    $("#month_list").html("");
    for(var i=0; i<monthly_items.length; i++) {
      var info = monthly_items[i];
      var item = $('<a href="#" class="list-group-item list-group-item-action" onclick="load_marp_md_by_file('+year+', \''+info.filename+'\')">\
        <div class="d-flex w-100 justify-content-between">\
          '+info.date.slice(6)+'일\
          ('+info.day+') - \
          '+info.title+'\
        </div>\
      </a>');
      $("#month_list").append(item);
      count += 1;
    }

    if(count == 0) {
      var item = $('<a href="#" class="list-group-item list-group-item-action">\
        불러 올 자료가 없습니다\
      </a>');
      $("#month_list").append(item);
    }
  }

  const year = (new Date()).getFullYear();
  const mass_indexes_url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/'+year+'/indexes.json';
  const response = await fetch(mass_indexes_url);
  const indexes = await response.json();

  for(var i=1; i<=12; i++) {
    const month = i;
    document.getElementById('load_'+month).addEventListener('click', async () => {
      var monthly_items = [];
      var m = ''+month;
      if(month < 10)
        m = '0'+month;
      for (var i=0; i<indexes.length; i++) {
        var info = indexes[i];
        if(info.filename.startsWith(year+m)) {
          monthly_items.push(info);
        }
      }
      listup_month(year, monthly_items);

      $("#monthModalLabel").text(""+month+"월 미사 목록");
      $("#monthModal").modal("show")
    });
  }


  var prayers = ["감사기도", "강복", "거룩하시도다", "니케아콘스탄티노플리스신경", "대영광송", "부속가", "부활삼종기도", "사도신경", "삼종기도-성모송포함", "삼종기도", "성모송", "신앙의신비", "영성체전기도", "예물준비기도", "자비송", "주님의기도", "참회예절", "파견", "평화예식", "하느님의어린양"];
  for(var i=0; i<prayers.length; i++) {
    const prayer_name = prayers[i];
    var item = $('<li><a class="dropdown-item" href="#" id="p_'+i+'">\
        '+prayers[i]+'</a></li>');
    $("#prayer_list").append(item);

    document.getElementById('p_'+i).addEventListener('click', async () => {
      const url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/prayers/'+prayer_name+'.md';
      $("#progressdiv").html('<div class="spinner-border" role="status"></div> 데이타 가져오는 중...').slideDown(500);
      const response = await fetch(url);
      var md = await response.text();

      var pos = ace_editor.getCursorPosition();
      var ready = false;
      var done = false;
      var lines = ace_editor.getValue().split("\n");
      var dash_count = 0;
      for(var i=0; i<lines.length; i++) {
        if(pos.row == i)
          ready = true;
        var l = lines[i].trim();
        if(l=="---")
          dash_count += 1;

        if(dash_count > 2 && l=="---" && ready && !done) {
          ace_editor.gotoLine(i, 0);
          ace_editor.insert("\n---\n\n"+md.trim()+"\n\n");
          done = true;
        }
      }
      if (!done) {
        ace_editor.gotoLine(lines.length+1, 0);
        ace_editor.insert("\n\n---\n\n"+md.trim());
      }

      preview();

      $("#progressdiv").html(prayer_name+'을(를) 다음장에 추가 하였습니다.').slideDown(500).delay(1000).slideUp(500);
    });
  }


  const decompress = base64string => {
    const bytes = Uint8Array.from(atob(base64string), c => c.charCodeAt(0));
    const cs = new DecompressionStream('gzip');
    const writer = cs.writable.getWriter();
    writer.write(bytes);
    writer.close();
    return new Response(cs.readable).arrayBuffer().then(function (arrayBuffer) {
        return new TextDecoder().decode(arrayBuffer);
    });
  }

  async function load_from_hash() {
    const hashstring = window.location.hash.slice(1);
    var n = new Date();
    if(hashstring == "today") {
      load_marp_md(+new Date());
      return;
    } else if(hashstring == "tomorrow") {
      load_marp_md(+new Date() + 86400000);
      return;
    } else if(hashstring == "saturday") {
      load_marp_md(+n+86400000*(6-n.getDay()));
      return;
    } else if(hashstring == "sunday") {
      load_marp_md(+n+86400000*(7-n.getDay()));
      return;
    } else if(hashstring.startsWith("2025") && hashstring.length<=10) {
      var url = 'https://raw.githubusercontent.com/kcatholic-api/kmass-marp/refs/heads/main/templates/2025/'+hashstring+'.md';
      const response = await fetch(url);
      ace_editor.setValue(await response.text(), -1);
      ace_editor.session.setScrollTop(0);
      $("#alertdiv").html(hashstring+"의 Markdown 템플릿을 로드 하였습니다.").slideDown(500).delay(1000).slideUp(500);
      return;
    }
    const b64str = hashstring;
    decompress(b64str).then(function(str) {
      ace_editor.setValue(str.trim(), -1);
      ace_editor.session.setScrollTop(0);
      $("#alertdiv").html("공유링크에서 Markdown 문서를 추출하여 로드하였습니다.").slideDown(500).delay(1000).slideUp(500);
      preview();
    });
  }
  window.addEventListener('hashchange', () => {
    load_from_hash();
  });

  if(window.location.hash != '') {
    load_from_hash();
  } else {
    const response = await fetch('tutorial.md');
    ace_editor.setValue(await response.text(), -1);
    ace_editor.session.setScrollTop(0);
  }
</script>
</html>
