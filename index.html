
<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>한국어 미사 슬라이드덱 편집기</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.40.0/ace.js" integrity="sha512-fIGectJ0WRU6B2gx99VwpUsCu5T3pqAkPOLE2BJD5wowKmpejvdYg62WvsQ6f3jfOC5EGL0y0ZLcXnnc+oWG9g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago@1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard-js@0.3.6/clipboard.min.js"></script>


    <!--<link rel="icon" href="favicon.ico">-->

  </head>
  <body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="">미사 슬라이드덱 편집기</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#">오늘</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#">내일</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#">이번 토요일</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#">이번 일요일</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">2025년</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">1월</a></li>
            <li><a class="dropdown-item" href="#">2월</a></li>
            <li><a class="dropdown-item" href="#">3월</a></li>
            <li><a class="dropdown-item" href="#">4월</a></li>
            <li><a class="dropdown-item" href="#">5월</a></li>
            <li><a class="dropdown-item" href="#">6월</a></li>
            <li><a class="dropdown-item" href="#">7월</a></li>
            <li><a class="dropdown-item" href="#">8월</a></li>
            <li><a class="dropdown-item" href="#">9월</a></li>
            <li><a class="dropdown-item" href="#">10월</a></li>
            <li><a class="dropdown-item" href="#">11월</a></li>
            <li><a class="dropdown-item" href="#">12월</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">기도문 추가</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">주기도문</a></li>
            <li><a class="dropdown-item" href="#">사도신경</a></li>
            <li><a class="dropdown-item" href="#">삼종기도</a></li>
          </ul>
        </li>
      </ul>
      <!--
      <form class="form-inline my-2 my-lg-0">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="https://marpit.marp.app/markdown" target="_blank">Marpit Markdown 도움말</a>
          </li>
        </ul>
      </form>
      -->
    </div>
  </div>
</nav>

<!-- Load Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="loadModalLabel">로컬 브라우져 저장소 불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="list-group" id="saved">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="shareModalLabel">다른 슬라이드덱 봉사자와 편집 내용 공유하기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>편집 중인 마크다운 소스를 직접 파일에 저장 또는 Email로 공유 하거나 다음의 주소를 보내어 다른 사람과 편집 내용을 쉽게 공유할 수 있습니다.</small>
        </p>
        <div class="card">
          <h5 class="card-header">URL</h5>
          <div class="card-body" id="shareURL">
          </div>
        </div>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="clipboard.copy($('#shareURL').text().trim());">복사</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>


<main class="container-fluid">
  <div class="row">
    <div id="alertdiv" class="alert alert-success" role="alert" style="display: none"></div>
    <p><small>이 생각보다 은근히 편리한 미사 슬라이드덱 편집기는 마크다운(Markdown) 문법을 사용하는 <span id="dotdotdot">...</span><span id="moreText" class="collapse">Marpit이라는 오픈소스 도구를 사용하여 천주교 미사를 위한 슬라이드 장표를 깔끔하게 만들어 줄 수 있답니다. 원래 코딩을 해본적 있는 바쁜 교회 봉사자를 위하여 만들어 졌지만, 하느님의 은총으로 당신도 뚝딱 배워서 봉사에 사용할 수 있을 지도 몰라요. 자세한 문법 설명이 있는 <a href="https://commonmark.org/help/tutorial/" target="_blank">마크다운 자습서</a>와 <a href="https://marpit.marp.app/markdown" target="_blank">Marpit 설명서</a>를 읽어 보신 후 주님의 기도 3번 바쳐보세요.</span> <a id="readMore" data-bs-toggle="collapse" href="#moreText" aria-expanded="false" aria-controls="moreText"><small>더 보기</small></a></small></p>
  </div>
  <div class="row">
    <div class="col-md-6">
      <table style="width: 100%">
        <tr>
          <td>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우저 데이타베이스에서 불러오기" onclick="$('#loadModal').modal('show');update_saved_docs();"><i class="bi bi-folder2-open"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우저에 데이타베이스에 저장" onclick="save_edit()"><i class="bi bi-floppy2"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="클립보드에 복사" onclick="clipboard_copy()"><i class="bi bi-copy"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="공유 하기" id="shareButton"><i class="bi bi-box-arrow-up"></i></button>
          </td>
          <td style="text-align: right;">
            <input class="form-check-input" type="checkbox" value="" id="vim_mode" onclick="set_keybinding(this.checked)">
            <label class="form-check-label" for="vim_mode" data-bs-toggle="tooltip" data-bs-placement="top" title="Vim 키 바인딩으로 편집합니다">
              Vim 키바인딩
            </label>
          </td>
        </tr>
      </table>
    </div>
    <div class="col-md-6">
      <table style="width: 100%">
        <tr>
          <td>
            <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked onclick="set_link(this.checked)">
            <label class="form-check-label" for="flexSwitchCheckChecked" data-bs-toggle="tooltip" data-bs-placement="top" title="왼쪽 편집기와 오른쪽 미리보기의 스크롤을 연결하거나 독립적으로 스크롤 합니다">스크롤 연결</label>
          </div>
          </td>
          <td style="text-align: right;">
            <button type="button" id="openWindow" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="브라우져를 이용한 프레젠테이션 모드 시작하기" onclick=""><i class="bi bi-easel2"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="PDF 저장을 위해 브라우저의 인쇄 기능을 사용합니다" onclick=""><i class="bi bi-printer"></i></button>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div id="mdrow" class="row">
    <div class="col-md-6" id="leftPane" style="overflow-y: scroll; height: 100%">
      <div id="editor" style="height: 100%; width: 100%; border-style: solid; border-color: #eeeeee">---
# 첫장은 슬라이드덱 옵션을 YAML로 설정하는 용도 입니다
# 주석(#)을 수정하고 값을 바꾸어 다양하게 꾸며 보세요
marp: true
theme: gaia
_class: lead
paginate: true
backgroundImage: url("https://marp.app/assets/hero-background.svg")
#backgroundColor: #000000
#color: #ffffff
---
&lt;!-- 여기서 부터 마크다운(Markdown) 으로 슬라이드를 작성 합니다 --&gt;

# 마크다운으로 천주교 미사 슬라이드덱 만들기

![h:250](https://kcatholic-api.github.io/abudhabi/mass/images/logo.svg)

## 예제를 통해 5분만에 배워 봅시다

왼쪽 편집기에서 Markdown 코드를 수정해 보세요

&lt;!-- 커버 페이지 입니다.
Heading 1(#)을 사용하여 제목을 중간에 위치해 보세요.
![h:높이](이미지URL)을 추가하여 소속 공동체의 로고를 넣어보세요.
--&gt;

---

## 기본적인 작성 규칙

제목은 # 또는 ## 으로 입력, 페이지 추가는 --- 을 추가하면 됩니다.
왼쪽의 편집기를 이용하여 예제 페이지들을 직접 수정해 보세요!

```markdown
# 첫번째 슬라이드 페이지

슬라이드 내용
◎ 아멘

---

# 두번째 슬라이드 페이지

* 리스트 아이템 1
* 리스트 아이템 2
* 리스트 아이템 3
```

---

&lt;!-- Marpit Markdown 문법에 따라 페이지 분리선(---)으로 슬라이드덱을 추가할 수 있습니다 --&gt;

# 입당 성가 129 - 알렐루야 노래하자

알렐루야 노래하자 기쁜때가- 왔도다

온세상에 기쁜소식 용약하여- 전하자

우리예수 부활하-사 우리죽음 물리쳤-네

알렐루야 주예수 기쁘고 즐겁다

영화로-이- 사셨네-

&lt;!-- 커버 페이지 예제에 나온 이미지 삽입 방식을 통하여 가사 대신에 악보그림을 넣는 것도 좋은 방법입니다. --&gt;

---

## 부활 삼종 기도

○ 하늘의 모후님, 기뻐하소서. 알렐루야.

● 태중에 모시던 아드님이, 알렐루야.

○ 말씀하신 대로 부활하셨나이다. 알렐루야.

● 저희를 위하여 하느님께 빌어주소서. 알렐루야.

○ 동정 마리아님, 기뻐하시며 즐거워하소서. 알렐루야.

● 주님께서 참으로 부활하셨나이다. 알렐루야.

&lt;!-- 너무 줄이 길면 페이지 분리선(---)을 넣어 여러장에 나누어 입력하세요 --&gt;

---

&lt;!-- 이 예제와 처럼 Heading (#)을 꼭 넣지 않아도 됩니다. --&gt;

† 기도합시다.

하느님, 성자 우리 주 예수 그리스도의 부활로

온 세상을 기쁘게 하셨으니

성자의 어머니 동정마리아의 도움으로

영생의 즐거움을 얻게 하소서

우리 주 그리스도를 통하여 비나이다.

<b>◎ 아멘.</b>

---

## 성수 예절

교우 여러분은 성수가 뿌려질 때, 고개를 숙이고 성호를 그으십시오.

---

## 감사 기도

╋ 주님께서 여러분과 함께
◎ 또한 사제의 영과 함께

╋ 마음을 드높이
◎ 주님께 올립니다.

╋ 우리 주 하느님께 감사합시다.
◎ 마땅하고 옳은 일입니다.

---

## 공지 사항

* 첫 영성체 교육이 다음 주 부터 시작됩니다.
* 오늘 주일학교는 장소 문제로 휴강입니다.
* 다음 주 성가대 연습 장소가 아씨시홀로 변경되었습니다.

---

## 미사가 모두 끝났습니다&lt;!--fit--&gt;

&lt;!--
"fit"를 Heading 1에 주석으로 넣어 보세요.
제목을 화면에 꽉 채울 수 있습니다.
--&gt;

은헤로운 한주 되세요.
      </div>
    </div>
    <div id="rightPane" class="col-md-6" style="height: 100%">
      <div id="render" style="flex: 1; overflow-y: scroll; height: 100%; border-style: solid; border-color: #eeeeee"></div>
    </div>
  </div>
</main>
  <footer style="text-align: center" class="pt-2">
    <p class="fs-6"><small>평화를 빕니다! <a href="https://kcatholic-api.github.io/" target="_blank">한국어 카톨릭 API 프로젝트</a>를 방문하여 보세요.</small></p>
  </footer>
  </body>

<script>
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

console.log("script");
var ace_editor = ace.edit("editor");
ace_editor.session.setMode("ace/mode/markdown");
ace_editor.session.setUseWrapMode(true);
ace_editor.commands.addCommand({
  name: 'save',
  bindKey: {win: "Ctrl-S", "mac": "Cmd-S"},
  exec: function(editor) {
  }
});
ace_editor.setOptions({
  fontFamily: "Monospace",
  fontSize: "11pt"
});

function set_keybinding(flag) {
  if(flag) {
    ace_editor.setKeyboardHandler("ace/keyboard/vim");
    ace.config.loadModule("ace/keyboard/vim", function(module) {
      var vimAPI = module.CodeMirror.Vim;
      vimAPI.defineEx("wirte", "w", function(cm, input) {
        save_edit()
      });
    });
  } else
    ace_editor.setKeyboardHandler("ace/keyboard/vscode");
}

function set_editor_height() {
  var guessheight = $(window).height() - $("#mdrow").offset().top - 50;
  $("#mdrow").css("height", guessheight);
  if($(window).width() < 768) {
    $("#leftPane").css("height", "50%");
    $("#rightPane").css("height", "50%");
  } else {
    $("#leftPane").css("height", "100%");
    $("#rightPane").css("height", "100%");
  }
}

$(window).on("resize", set_editor_height);
set_editor_height();

function r2l(ev) {
  var top = $("#render").scrollTop();
  var height = $("#render").prop("scrollHeight");
  var target_height = ace_editor.session.getScreenLength() * ace_editor.renderer.lineHeight;
  var target_top = top * target_height / height;
  ace_editor.session.off("changeScrollTop", l2r);
  ace_editor.session.setScrollTop(target_top);
  setTimeout(function() {
    ace_editor.session.on("changeScrollTop", l2r);
  }, 100)
}
function l2r(ev) {
  var top = ace_editor.session.$scrollTop;
  var height = ace_editor.session.getScreenLength() * ace_editor.renderer.lineHeight;
  var target_height = $("#render").prop("scrollHeight");
  var target_top = top * target_height / height;
  $("#render").off("scroll", r2l);
  $("#render").scrollTop(target_top);
  setTimeout(function() {
    $("#render").on("scroll", r2l);
  }, 100)
}

function set_link(flag) {
  if(flag) {
    $("#render").on("scroll", r2l);
    ace_editor.session.on("changeScrollTop", l2r);
  } else {
    $("#render").off("scroll", r2l);
    ace_editor.session.off("changeScrollTop", l2r);
  }
}
set_link(true);

function clipboard_copy() {
  clipboard.copy(ace_editor.getValue());
  $("#alertdiv").html("현재 편집중인 내용을 클립보드에 복사 하였습니다.").slideDown(500).delay(1000).slideUp(500);
}

function save_edit() {
  var title = "제목 없음";
  lines = ace_editor.getValue().split("\n");
  dash_count = 0;
  for(var i=0; i<lines.length; i++) {
    var l = lines[i].trim();
    if(l == "---")
      dash_count += 1;
    else if(dash_count >= 2 && l.startsWith("# ")) {
      title = l.slice(2).trim();
      var p = title.search("<!--");
      if(p>0)
        title = title.slice(0, p).trim();
      break;
    }
  }

  $("#alertdiv").html('"'+title+'"'+"<br/>이(가) 로컬 브라우져 저장소에 저장되었습니다").slideDown(500).delay(1000).slideUp(500);
  localStorage.setItem(title, JSON.stringify({date: new Date(), content: ace_editor.getValue()}));

  update_saved_docs(title);
}

function restore_edit(index) {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    if(index == i) {
      var cache = JSON.parse(localStorage.getItem(localStorage.key(i)));
      ace_editor.setValue(cache.content);
      update_saved_docs(localStorage.key(i));
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function restore_cache() {
  ace_editor.getSession().off("change", cache_save_handler);

  // load cache
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "cache") {
      var cache = JSON.parse(localStorage.getItem(name));
      ace_editor.setValue(cache.content);
      break;
    }
  }

  ace_editor.getSession().on("change", cache_save_handler);
  $("#loadModal").modal("hide");
}

function update_saved_docs(highlight) {
  $("#saved").html("");

  var count = 0;
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "cache") {
      var cache = {date: new Date, content: ""};
      try {
        cache = JSON.parse(localStorage.getItem("cache"));
      } catch (e) {
        continue;
      }
      var item = $('<a href="#" class="list-group-item list-group-item-action" onclick="restore_cache()">\
        <div class="d-flex w-100 justify-content-between">\
          <strong>[저장하지 않은 내용 복원]</strong>\
          <small> \
            <time class="timeago" datetime="'+cache.date+'"></time> \
            <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
          </small> \
        </div>\
      </a>');
      $("#saved").append(item);
      count += 1;
      break;
    }
  }

  // load saved slides
  for(var i=0; i<localStorage.length; i++) {
    var name = localStorage.key(i);
    if(name == "cache")
      continue;
    var content = {date: new Date, content: ""};
    try {
      content = JSON.parse(localStorage.getItem(localStorage.key(i)));
    } catch (e) {
      continue;
    }
    var active = "";
    if(name == highlight)
      active = " active";
    var item = $('<a href="#" class="list-group-item list-group-item-action" onclick="restore_edit('+i+')">\
      <div class="d-flex w-100 justify-content-between">\
        '+name+'\
        <small> \
          <time class="timeago" datetime="'+content.date+'"></time> \
          <i class="bi bi-trash" onclick="localStorage.removeItem(localStorage.key('+i+')); update_saved_docs()"></i> \
        </small> \
      </div>\
    </a>');
    $("#saved").append(item);
    count += 1;
  }

  if(count == 0) {
    var item = $('<a href="#" class="list-group-item list-group-item-action">\
      브라우져 로컬 저장소가 비었습니다.\
    </a>');
    $("#saved").append(item);
  }
  $("time.timeago").timeago();
}

function cache_save_handler() {
  console.log("cache save");
  localStorage.setItem("cache", JSON.stringify({date: new Date(), content: ace_editor.getValue()}));
}
ace_editor.getSession().on("change", cache_save_handler);

$("#readMore").on("click", function() {
  var $this = $(this);
  $("#dotdotdot").text($("#dotdotdot").text() == ""?"...":"")
  $this.text($this.text() == '더 보기' ? '간략히' : '더 보기');
  set_editor_height();
});
</script>

<script type="module">
  import { Marp } from 'https://esm.sh/@marp-team/marp-core?bundle'
  import browser from 'https://esm.sh/@marp-team/marp-core/browser'
  const marp = new Marp({ script: false })
  console.log("module");

  function preview() {
    const { html, css } = marp.render(ace_editor.getValue().trim());
    render.innerHTML = `${html}<style>${css}</style>`;
    //browser(render);
  }

  editor.addEventListener('input', () => {
    preview();
  });


  document.getElementById('openWindow').addEventListener('click', () => {
    const mdContent = ace_editor.getValue().trim();
    const { html, css } = marp.render(mdContent);
    const slideWindow = window.open('#2', '_blank');
    slideWindow.document.write(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <style>${css}</style>
      </head>
      <body>${html}</body>
      </html>
    `);
    //browser(slideWindow.document.body);
  });

  preview();

  ace_editor.getSession().on("change", preview);

  document.getElementById('shareButton').addEventListener('click', async () => {
    var data = ace_editor.getValue()

    let stream = new Blob([data], {
          type: 'text/plain',
    }).stream();

    const compressedReadableStream = stream.pipeThrough(
        new CompressionStream("gzip")
    );
    const compressedResponse = await new Response(compressedReadableStream);
    const blob = await compressedResponse.blob();

    const buffer = await blob.arrayBuffer();

    const compressedBase64 = btoa(
      String.fromCharCode(
        ...new Uint8Array(buffer)
      )
    );

    var url = window.location.toString();
    var hash_pos = url.search('#');
    if(hash_pos > 0) {
      url = url.slice(0, hash_pos);
    }
    url = url + "#"+compressedBase64;

    $("#shareURL").text(url);
    $("#shareModal").modal("show");
  });

  const decompress = base64string => {
    const bytes = Uint8Array.from(atob(base64string), c => c.charCodeAt(0));
    const cs = new DecompressionStream('gzip');
    const writer = cs.writable.getWriter();
    writer.write(bytes);
    writer.close();
    return new Response(cs.readable).arrayBuffer().then(function (arrayBuffer) {
        return new TextDecoder().decode(arrayBuffer);
    });
  }

  function load_from_hash() {
    if(window.location.hash != '') {
      const b64str = window.location.hash.slice(1);
      decompress(b64str).then(function(str) {
        ace_editor.setValue(str.trim());
        preview();
      });
    }
  }
  window.addEventListener('hashchange', () => {
    load_from_hash();
  });

  load_from_hash();


</script>
</html>
